<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìˆ˜ì‹œìƒë‹´ (ì „ì²´)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary-color: #4364f7; --secondary-color: #6a8eff; --success-color: #28a745; --light-gray: #f8f9fa; --medium-gray: #e9ecef; --dark-gray: #495057; --border-radius: 6px; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--light-gray); padding: 20px; }
        h2 { color: var(--primary-color); }
        .section { background-color: white; padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow-x: auto; }
        .controls-wrap { display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 10px; }
        .filter-wrap { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        select, button { padding: 8px; border-radius: 4px; border: 1px solid var(--medium-gray); font-size: 14px; }
        button { background-color: var(--primary-color); color: white; cursor: pointer; border: none; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-add { background-color: var(--success-color); }
        #result-title { margin-bottom: 15px; font-size: 1.2em; font-weight: 500; color: var(--dark-gray); border-bottom: 2px solid var(--medium-gray); padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 1px solid var(--medium-gray); padding: 8px; text-align: center; font-size: 12px; vertical-align: middle; }
        th { background-color: var(--primary-color); color: white; font-weight: 500; white-space: nowrap; }
        input { width: 95%; box-sizing: border-box; text-align: center; border: 1px solid var(--medium-gray); border-radius: 4px; padding: 4px; font-size: 12px; }

        .col-name { width: 80px; }
        .col-grade, .col-gender { width: 50px; }
        .col-rating { width: 70px; }
        .col-score { width: 80px; }
        .col-total-practical, .col-total-sum { width: 90px; }
        
        .practical-input-group { display: flex; align-items: center; justify-content: center; gap: 4px; }
        .input-record { width: 60px; }
        .input-score-only { width: 40px; background-color: #f0f0f0; border: none; padding: 4px; }
        .gam-span { color: red; font-size: 11px; font-weight: bold; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1200px; border-radius: var(--border-radius); position: relative; }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        #modalTitle { margin-bottom: 20px; color: var(--primary-color); }
        #modalTableContainer { display: flex; gap: 16px; overflow-x: auto; }
        #modalTableContainer table { min-width: 300px; }

        /* [ì´ ì½”ë“œë¥¼ style íƒœê·¸ ì•ˆì— ì¶”ê°€] */

#result-title-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 15px;
    border-bottom: 2px solid var(--medium-gray);
    padding-bottom: 10px;
}

#result-title {
    margin: 0;
    border: none;
    padding: 0;
}

#cut-scores-display {
    font-size: 0.9em;
    color: var(--dark-gray);
    font-weight: 500;
}

#cut-scores-display span {
    margin-left: 15px;
}

.highlight-score {
    color: var(--primary-color) !important;
    font-weight: bold;
    font-size: 1.1em;
}

/* [ì¶”ê°€] í…Œì´ë¸” ë ˆì´ì•„ì›ƒ ë³€ê²½ */
table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto; /* ë‚´ìš©ì— ë”°ë¼ ë„ˆë¹„ ìë™ ì¡°ì ˆ */
}

/* [ì¶”ê°€] thì™€ tdì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€ */
th, td {
    border: 1px solid var(--medium-gray);
    padding: 8px;
    text-align: center;
    font-size: 12px;
    vertical-align: middle;
    white-space: nowrap; /* ë‚´ìš©ì´ í•œ ì¤„ë¡œ í‘œì‹œë˜ë„ë¡ */
    overflow: hidden; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ìˆ¨ê¹€ */
    text-overflow: ellipsis; /* ë„˜ì¹˜ëŠ” ë‚´ìš©ì— ... í‘œì‹œ */
}

/* [ì¶”ê°€] ì…ë ¥ í•„ë“œ ë„ˆë¹„ ì¡°ì • (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) */
input {
    width: 95%;
    box-sizing: border-box;
    text-align: center;
    border: 1px solid var(--medium-gray);
    border-radius: 4px;
    padding: 4px;
    font-size: 12px;
}

/* [ì¶”ê°€] thì—ë§Œ ìµœì†Œ ë„ˆë¹„ ì„¤ì • (í•„ìš”ì— ë”°ë¼ ì¡°ì ˆ) */
th {
    min-width: 80px; /* ìµœì†Œ ë„ˆë¹„ ë³´ì¥ */
}

/* [ì¶”ê°€] ë‚´ìš©ì´ ë§ì€ ì»¬ëŸ¼ì— ë” ë§ì€ ê³µê°„ ë¶€ì—¬ (ì˜ˆì‹œ) */
th:nth-child(1), td:nth-child(1) { /* ì´ë¦„ ì»¬ëŸ¼ */
    min-width: 120px;
}

/* [ì¶”ê°€ - ì„ íƒ ì‚¬í•­] ì‘ì€ í™”ë©´ì—ì„œ í°íŠ¸ í¬ê¸° ì¤„ì´ê¸° */
@media (max-width: 768px) {
    th, td {
        font-size: 10px;
        padding: 6px;
    }
}

/* [ì¶”ê°€ - ì„ íƒ ì‚¬í•­] ë” ì‘ì€ í™”ë©´ì—ì„œ íŠ¹ì • ì»¬ëŸ¼ ìˆ¨ê¸°ê¸° (ì˜ˆì‹œ) */
@media (max-width: 576px) {
    #resultTable th:nth-child(4), /* ë“±ê¸‰ ì»¬ëŸ¼ ìˆ¨ê¸°ê¸° */
    #resultTable td:nth-child(4) {
        display: none;
    }
}
    </style>
</head>
<body>

    <div class="section">


<h2 id="main-title">2026ë§¥ìŠ¤ì²´ëŒ€ì…ì‹œ êµìœ¡ì› ìˆ˜ì‹œìƒë‹´ (ì „ì²´)</h2>
        <div class="controls-wrap">
            <div class="filter-wrap">
                <div><label for="sel-college">ëŒ€í•™ëª…</label><select id="sel-college" onchange="onCollegeChange()"></select></div>
                <div><label for="sel-major">í•™ê³¼ëª…</label><select id="sel-major" onchange="onMajorChange()" disabled></select></div>
                <div><label for="sel-type">ì „í˜•ëª…</label><select id="sel-type" onchange="document.getElementById('btn-score-table').disabled = !this.value;"></select></div>
                <button onclick="searchConsultations()">ì¡°íšŒ</button>
                <button id="btn-score-table" onclick="openScoreTablePopup()" disabled>ë°°ì í‘œ ë³´ê¸°</button>
            </div>
            <div>
                <button class="btn-add" onclick="openStudentAddModal()">+ í•™ìƒ ì¶”ê°€</button>
                <button onclick="saveGroupData()">ğŸ’¾ ì „ì²´ ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="section">
<div id="result-title-container">
    <h3 id="result-title"></h3>
    <div id="cut-scores-display"></div>
</div>
        <table id="resultTable">
            <thead></thead>
            <tbody id="resultTbody">
                <tr><td colspan="8">ì¡°íšŒí•  ëŒ€í•™/í•™ê³¼/ì „í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>
            </tbody>
        </table>
    </div>

    <div id="scoreTableModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalTableContainer"></div>
        </div>
    </div>

    <script>
        const SERVER = 'https://supermax.kr';
        const token = localStorage.getItem('token');
        if (!token) location.href = 'login.html';

        let colleges = [], collegeGroups = {}, allBranchStudents = [];
        let currentCollege = null, currentStudentMap = {}, practicalEvents = [];
        let scoreTableCache = new Map();

        const isReverseEvent = (eventName) => ['10', '20', 'run', '100', 'z', 'ë‹¬ë¦¬ê¸°','ë²½ì¹˜ê¸°'].some(k => eventName.toLowerCase().includes(k));
        function calculateTotalScore(row) { let total = 0; row.querySelectorAll('.input-score-only').forEach(inp => { total += parseFloat(inp.value || 0); }); return total; }
        function calculateReflectedScore(row) { if (!currentCollege) return 0; const rawScore = calculateTotalScore(row); if (!currentCollege.ì‹¤ê¸°ë°˜ì˜ì´ì  || !currentCollege.ê¸°ì¤€ì´ì ) return rawScore; return (rawScore / currentCollege.ê¸°ì¤€ì´ì ) * currentCollege.ì‹¤ê¸°ë°˜ì˜ì´ì ; }
        function calculateTotalSum(row) { const reflectedScore = calculateReflectedScore(row); const naesinScore = parseFloat(row.querySelector('.input-score').value) || 0; return reflectedScore + naesinScore; }
        function calculateGam(student, eventName, studentScore) { const cachedData = scoreTableCache.get(currentCollege.ì‹¤ê¸°ID); if (!cachedData || !cachedData[eventName] || !student) return 0; const scoreList = cachedData[eventName][student.ì„±ë³„]; if (!scoreList || scoreList.length === 0) return 0; const scores = scoreList.map(item => parseFloat(item.ë°°ì )).sort((a, b) => b - a); if (!studentScore || studentScore >= scores[0]) return 0; const studentScoreIndex = scores.indexOf(parseFloat(studentScore)); return studentScoreIndex === -1 ? 0 : studentScoreIndex; }


        
// [ì´ í•¨ìˆ˜ë¡œ í†µì§¸ë¡œ êµì²´í•˜ì„¸ìš”]

// [ê¸°ì¡´ onRecordInputChange í•¨ìˆ˜ë¥¼ ì´ê±¸ë¡œ êµì²´]

async function onRecordInputChange(input) {
    const row = input.closest('tr');
    const studentID = row.dataset.studentId;
    const student = currentStudentMap[studentID];
    if (!currentCollege || !student) return;

    const recordInputs = row.querySelectorAll('input.input-record');
    const scoreInputs = row.querySelectorAll('input.input-score-only');
    const inputsPayload = Array.from(recordInputs).map(inp => { const eventName = inp.dataset.eventName; const recordValue = inp.value.trim(); const finalRecord = (isReverseEvent(eventName) && recordValue === '0') ? null : (recordValue || null); return { ì¢…ëª©ëª…: eventName, ê¸°ë¡: finalRecord }; });
    const res = await fetch(`${SERVER}/26susi/calculate-score`, { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ ì‹¤ê¸°ID: currentCollege.ì‹¤ê¸°ID, gender: student.ì„±ë³„, inputs: inputsPayload }) });
    const json = await res.json();
    if (!json.ì¢…ëª©ë³„ê²°ê³¼) return;

    let totalGam = 0;
    json.ì¢…ëª©ë³„ê²°ê³¼.forEach((result, i) => {
        const scoreInput = scoreInputs[i];
        if (!scoreInput) return;
        scoreInput.value = result.ë°°ì ;
        const eventName = recordInputs[i].dataset.eventName;
        const gam = calculateGam(student, eventName, result.ë°°ì );
        totalGam += gam;
        const practicalGroup = scoreInput.closest('.practical-input-group');
        let gamSpan = practicalGroup.querySelector('.gam-span');
        if (!gamSpan) { gamSpan = document.createElement('span'); gamSpan.className = 'gam-span'; practicalGroup.appendChild(gamSpan); }
        gamSpan.textContent = gam > 0 ? `(${gam}ê°)` : '';
    });

    const reflectedScore = calculateReflectedScore(row);
    const totalScoreCell = row.querySelector('.total-score-cell');
    totalScoreCell.innerHTML = reflectedScore >= 0 ? reflectedScore.toFixed(2) : '-';
    if (totalGam > 0) { totalScoreCell.innerHTML += `<span style="color:red; font-weight:bold; margin-left:5px;">(ì´ ${totalGam}ê°)</span>`; }
    
    const totalSum = calculateTotalSum(row);
    const totalSumCell = row.querySelector('.total-sum-cell');
    totalSumCell.textContent = totalSum >= 0 ? totalSum.toFixed(2) : '-';

    // âœ… [ìˆ˜ì •] í•©ì‚°ì ìˆ˜ì™€ ë§¥ìŠ¤ì˜ˆìƒì»· ë¹„êµ í›„ ìƒ‰ìƒ ë³€ê²½
    const maxCut = parseFloat(currentCollege['26ë§¥ìŠ¤ì˜ˆìƒì»·']);
    totalSumCell.classList.remove('highlight-score');
    if (!isNaN(maxCut) && totalSum > maxCut) {
        totalSumCell.classList.add('highlight-score');
    }
}
        
        async function openScoreTablePopup() { if (!currentCollege || !currentCollege.ì‹¤ê¸°ID) return; const modal = document.getElementById('scoreTableModal'); document.getElementById('modalTitle').textContent = `${currentCollege.ëŒ€í•™ëª…} - ${currentCollege.í•™ê³¼ëª…} (${currentCollege.ì „í˜•ëª…}) ë°°ì í‘œ`; const container = document.getElementById('modalTableContainer'); container.innerHTML = 'ë¡œë”© ì¤‘...'; modal.style.display = 'block'; try { const res = await fetch(`${SERVER}/26susi_get_score_table?ì‹¤ê¸°ID=${currentCollege.ì‹¤ê¸°ID}`, { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); if (data.success) { renderPopupScoreTable(data.events, container); } else { container.innerHTML = 'ë°°ì í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'; } } catch(e) { container.innerHTML = 'ë°°ì í‘œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.'; } }
        function renderPopupScoreTable(events, container) { let finalHTML = ''; const eventNames = Object.keys(events); eventNames.forEach(name => { const eventData = events[name]; const scoreMap = { ë‚¨: new Map(), ì—¬: new Map() }; const eventScores = new Set(); eventData.ë‚¨.forEach(item => { scoreMap.ë‚¨.set(item.ë°°ì , item.ê¸°ë¡); eventScores.add(item.ë°°ì ); }); eventData.ì—¬.forEach(item => { scoreMap.ì—¬.set(item.ë°°ì , item.ê¸°ë¡); eventScores.add(item.ë°°ì ); }); const sortedScores = Array.from(eventScores).sort((a, b) => Number(b) - Number(a)); let tableHTML = `<table><thead><tr><th colspan="3">${name}</th></tr><tr><th>ë°°ì </th><th>ë‚¨</th><th>ì—¬</th></tr></thead><tbody>`; sortedScores.forEach(score => { tableHTML += `<tr><td>${score}</td><td>${scoreMap.ë‚¨.get(score) || '-'}</td><td>${scoreMap.ì—¬.get(score) || '-'}</td></tr>`; }); tableHTML += '</tbody></table>'; finalHTML += tableHTML; }); container.innerHTML = finalHTML; }
        document.querySelector('#scoreTableModal .close-btn').onclick = () => { document.getElementById('scoreTableModal').style.display = 'none'; };

        // [ê¸°ì¡´ loadInitialData í•¨ìˆ˜ë¥¼ ì´ê±¸ë¡œ êµì²´]

async function loadInitialData() {
    const profilePromise = fetch(`${SERVER}/26susi/profile`, { headers: { 'Authorization': 'Bearer ' + token } }).then(res => res.json());
    const collegePromise = fetch(`${SERVER}/26susi_college_list`, { headers: { 'Authorization': 'Bearer ' + token } }).then(res => res.json());
    const studentPromise = fetch(`${SERVER}/26susi_student_list`, { headers: { 'Authorization': 'Bearer ' + token } }).then(res => res.json());

    try {
        const [profileData, collegeData, studentData] = await Promise.all([profilePromise, collegePromise, studentPromise]);

        // âœ… [ì¶”ê°€] í”„ë¡œí•„ ì •ë³´ì—ì„œ ì§€ì ëª…ì„ ê°€ì ¸ì™€ íƒ€ì´í‹€ ì„¤ì •
        if (profileData.success && profileData.user.branch) {
            document.getElementById('main-title').textContent = `2026ë§¥ìŠ¤ì²´ëŒ€ì…ì‹œ ${profileData.user.branch} êµìœ¡ì› ìˆ˜ì‹œìƒë‹´ (ì „ì²´)`;
        }

        // ë‚˜ë¨¸ì§€ ë°ì´í„° ì²˜ë¦¬
        if (collegeData.success) {
            colleges = collegeData.colleges;
            groupColleges();
            populateCollegeSelect();
        }
        if (studentData.success) {
            allBranchStudents = studentData.students;
        }
    } catch (e) {
        console.error("ì´ˆê¸° ë°ì´í„° ë¡œë”© ì‹¤íŒ¨", e);
        Swal.fire('ì˜¤ë¥˜', 'ì´ˆê¸° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}
        function groupColleges() { colleges.forEach(c => { if (!collegeGroups[c.ëŒ€í•™ëª…]) collegeGroups[c.ëŒ€í•™ëª…] = {}; if (!collegeGroups[c.ëŒ€í•™ëª…][c.í•™ê³¼ëª…]) collegeGroups[c.ëŒ€í•™ëª…][c.í•™ê³¼ëª…] = []; collegeGroups[c.ëŒ€í•™ëª…][c.í•™ê³¼ëª…].push(c.ì „í˜•ëª…); }); }
        function populateCollegeSelect() { const sel = document.getElementById('sel-college'); sel.innerHTML = '<option value="">ì„ íƒ</option>' + Object.keys(collegeGroups).sort().map(c => `<option value="${c}">${c}</option>`).join(''); }
        function onCollegeChange() { const c = document.getElementById('sel-college').value, s = document.getElementById('sel-major'); s.innerHTML = '<option value="">ì„ íƒ</option>'; document.getElementById('sel-type').innerHTML = '<option value="">ì„ íƒ</option>'; document.getElementById('btn-score-table').disabled = true; if (c && collegeGroups[c]) { s.innerHTML += Object.keys(collegeGroups[c]).sort().map(m => `<option value="${m}">${m}</option>`).join(''); s.disabled = false; } else { s.disabled = true; document.getElementById('sel-type').disabled = true; } }
        function onMajorChange() { const c = document.getElementById('sel-college').value, m = document.getElementById('sel-major').value, t = document.getElementById('sel-type'); t.innerHTML = '<option value="">ì„ íƒ</option>'; document.getElementById('btn-score-table').disabled = true; if (m && collegeGroups[c][m]) { t.innerHTML += collegeGroups[c][m].sort().map(type => `<option value="${type}">${type}</option>`).join(''); t.disabled = false; } else { t.disabled = true; } }
        async function fetchPracticalEvents(practicalId) { if (!practicalId) { practicalEvents = []; return; } const res = await fetch(`${SERVER}/26susi_events_by_practical_id?practical_id=${practicalId}&gender=ë‚¨`, { headers: { 'Authorization': 'Bearer ' + token } }); const data = await res.json(); practicalEvents = data.success ? data.events.map(e => e.ì¢…ëª©ëª…) : []; const scoreRes = await fetch(`${SERVER}/26susi_get_score_table?ì‹¤ê¸°ID=${practicalId}`, { headers: { 'Authorization': 'Bearer ' + token } }); const scoreData = await scoreRes.json(); if (scoreData.success) { scoreTableCache.set(practicalId, scoreData.events); } }

        // [ê¸°ì¡´ searchConsultations í•¨ìˆ˜ë¥¼ ì´ê±¸ë¡œ êµì²´]

async function searchConsultations() {
    const c = document.getElementById('sel-college').value, m = document.getElementById('sel-major').value, t = document.getElementById('sel-type').value;
    if (!c || !m || !t) { Swal.fire('ì•Œë¦¼', 'ëŒ€í•™, í•™ê³¼, ì „í˜•ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning'); return; }
    currentCollege = colleges.find(col => col.ëŒ€í•™ëª… === c && col.í•™ê³¼ëª… === m && col.ì „í˜•ëª… === t);
    if (!currentCollege) return;

    document.getElementById('btn-score-table').disabled = !currentCollege.ì‹¤ê¸°ID;
    Swal.fire({ title: 'ì¡°íšŒ ì¤‘...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    
    // âœ… [ìˆ˜ì •] íƒ€ì´í‹€ê³¼ ì˜ˆìƒì»·ì„ ì—¬ê¸°ì„œ í‘œì‹œ
    const titleEl = document.getElementById('result-title');
    const cutScoresEl = document.getElementById('cut-scores-display');
    titleEl.innerHTML = `<strong>${c} ${m} (${t})</strong>`;
    
    const maxCut = currentCollege['26ë§¥ìŠ¤ì˜ˆìƒì»·'] || '-';
    const branchCut = currentCollege['ì§€ì ì˜ˆìƒì»·'] || '-';
    cutScoresEl.innerHTML = `
        <span>ë§¥ìŠ¤ì»·: ${maxCut}</span>
        <span>ì§€ì ì»·: ${branchCut}</span>
    `;

    await fetchPracticalEvents(currentCollege.ì‹¤ê¸°ID);
    const res = await fetch(`${SERVER}/26susi_counsel_by_college?college_id=${currentCollege.ëŒ€í•™ID}`, { headers: { 'Authorization': 'Bearer ' + token } });
    const data = await res.json();
    Swal.close();
    
    if (data.success) {
        titleEl.innerHTML += ` <span style="font-size: 0.9em; color: #555;">(ì´ ${data.students.length}ëª…)</span>`;
        data.students.sort((a, b) => (b.í•©ì‚°ì ìˆ˜ || 0) - (a.í•©ì‚°ì ìˆ˜ || 0));
        renderTable(data.students, practicalEvents);
    } else { 
        Swal.fire('ì˜¤ë¥˜', 'ë°ì´í„° ì¡°íšŒ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); 
    }
}

        function renderTable(students, events) {
            const table = document.getElementById('resultTable'), thead = table.querySelector('thead'), tbody = table.querySelector('tbody');
            thead.innerHTML = ''; tbody.innerHTML = '';
            currentStudentMap = {}; students.forEach(s => currentStudentMap[s.í•™ìƒID] = s);
            let headerHTML = '<tr><th class="col-name">ì´ë¦„</th><th class="col-grade">í•™ë…„</th><th class="col-gender">ì„±ë³„</th><th class="col-rating">ë“±ê¸‰</th><th class="col-score">ë‚´ì‹ ì ìˆ˜</th>';
            events.forEach(e => headerHTML += `<th class="col-event">${e}</th>`);
            headerHTML += '<th class="col-total-practical">ì‹¤ê¸°ì´ì </th><th class="col-total-sum">í•©ì‚°ì ìˆ˜</th></tr>';
            thead.innerHTML = headerHTML;
            if (students.length === 0) { tbody.innerHTML = `<tr><td colspan="${7 + events.length}">í•´ë‹¹ ì „í˜•ìœ¼ë¡œ ìƒë‹´í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; return; }
            students.forEach(student => addStudentRow(student, events));
        }

        function addStudentRow(student, events) {
            const tbody = document.getElementById('resultTbody');
            if (tbody.querySelector(`tr[data-student-id="${student.í•™ìƒID}"]`)) { return; }
            if (tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
            const row = document.createElement('tr'); row.dataset.studentId = student.í•™ìƒID;
            let rowHTML = `<td>${student.ì´ë¦„}</td><td>${student.í•™ë…„}</td><td>${student.ì„±ë³„}</td><td><input class="input-grade" type="text" value="${student.ë‚´ì‹ ë“±ê¸‰ || ''}"></td><td><input class="input-score" type="text" value="${student.ë‚´ì‹ ì ìˆ˜ || ''}"></td>`;
            events.forEach((eventName, i) => { const record = student[`ê¸°ë¡${i+1}`]; const recordValue = (record === null || record == 0) ? '' : record; rowHTML += `<td><div class="practical-input-group"><input type="text" class="input-record" data-event-name="${eventName}" value="${recordValue}" oninput="onRecordInputChange(this)" placeholder="ê¸°ë¡"><input type="text" class="input-score-only" readonly><span class="gam-span"></span></div></td>`; });
            rowHTML += `<td class="total-score-cell">-</td><td class="total-sum-cell">-</td>`;
            row.innerHTML = rowHTML; tbody.appendChild(row);
            const firstInput = row.querySelector('.input-record');
            if (firstInput) onRecordInputChange(firstInput);
        }

        async function openStudentAddModal() { if (!currentCollege) { Swal.fire('ì•Œë¦¼', 'ë¨¼ì € ì¡°íšŒí•  ëŒ€í•™ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning'); return; } const displayedStudentIDs = Object.keys(currentStudentMap).map(id => parseInt(id, 10)); const availableStudents = allBranchStudents.filter(s => !displayedStudentIDs.includes(s.í•™ìƒID)); if (availableStudents.length === 0) { Swal.fire('ì•Œë¦¼', 'ì¶”ê°€í•  ìˆ˜ ìˆëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.', 'info'); return; } const inputOptions = {}; availableStudents.forEach(s => { inputOptions[s.í•™ìƒID] = `${s.ì´ë¦„} (${s.í•™ë…„ || 'í•™ë…„ì •ë³´ì—†ìŒ'})`; }); const { value: studentId } = await Swal.fire({ title: 'ìƒë‹´ì— ì¶”ê°€í•  í•™ìƒ ì„ íƒ', input: 'select', inputOptions: inputOptions, inputPlaceholder: 'í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”', showCancelButton: true }); if (studentId) { const studentToAdd = allBranchStudents.find(s => s.í•™ìƒID == studentId); currentStudentMap[studentId] = studentToAdd; addStudentRow(studentToAdd, practicalEvents); } }
       // [ê¸°ì¡´ saveGroupData í•¨ìˆ˜ë¥¼ ì´ê±¸ë¡œ í†µì§¸ë¡œ êµì²´]

async function saveGroupData() {
    if (!currentCollege) { Swal.fire('ì•Œë¦¼', 'ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ëŒ€í•™ì„ ì¡°íšŒí•´ì£¼ì„¸ìš”.', 'warning'); return; }
    Swal.fire({ title: 'ì €ì¥ ì¤‘...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

    const studentRows = document.querySelectorAll('#resultTbody tr[data-student-id]');
    const studentDataPayload = [];

    studentRows.forEach(row => {
        const studentID = row.dataset.studentId;
        const recordInputs = row.querySelectorAll('.input-record');
        const scoreInputs = row.querySelectorAll('.input-score-only');
        const data = {
            í•™ìƒID: studentID,
            ì‹¤ê¸°ID: currentCollege.ì‹¤ê¸°ID,
            ë‚´ì‹ ë“±ê¸‰: row.querySelector('.input-grade').value,
            ë‚´ì‹ ì ìˆ˜: row.querySelector('.input-score').value,
            ì‹¤ê¸°ì´ì : parseFloat(row.querySelector('.total-score-cell').textContent) || null,
            í•©ì‚°ì ìˆ˜: parseFloat(row.querySelector('.total-sum-cell').textContent) || null
        };
        recordInputs.forEach((inp, i) => {
            data[`ê¸°ë¡${i+1}`] = inp.value || null;
            data[`ì ìˆ˜${i+1}`] = scoreInputs[i].value || null;
        });
        studentDataPayload.push(data);
    });

    const payload = {
        college_id: currentCollege.ëŒ€í•™ID,
        studentData: studentDataPayload
    };



    try {
        const res = await fetch(`${SERVER}/26susi_counsel_by_college_save`, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        // fetchê°€ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì•„ë˜ ì½”ë“œ ì‹¤í–‰
        if (!res.ok) {
            // ì„œë²„ê°€ ì—ëŸ¬ ì‘ë‹µì„ ë³´ë‚¸ ê²½ìš° (500 ì—ëŸ¬ ë“±)
            const errorResult = await res.json();
            throw new Error(errorResult.message || `ì„œë²„ ì—ëŸ¬: ${res.status}`);
        }

        const result = await res.json();
        if (result.success) {
            Swal.fire('ì €ì¥ ì™„ë£Œ!', 'ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else {
            Swal.fire('ì €ì¥ ì‹¤íŒ¨', result.message, 'error');
        }

    } catch (error) {
        console.error("ì €ì¥ í•¨ìˆ˜ì—ì„œ ì—ëŸ¬ ë°œìƒ:", error);
        Swal.fire('ì „ì†¡ ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ì„œë²„ë¡œ ë³´ë‚´ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°œë°œì ë„êµ¬ ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
    }
}
        loadInitialData();
    </script>
</body>
</html>