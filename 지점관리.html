<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜í•© ë°ì´í„° ì—‘ì…€ ì¶”ì¶œ (ë¡œê·¸ì¸)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background-color: #f4f7f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #app { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); width: 100%; max-width: 500px; }
        h1 { border-bottom: 2px solid #007bff; padding-bottom: 10px; color: #333; margin-top: 0; }
        div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="password"], select {
            width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;
        }
        button {
            width: 100%; padding: 15px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s;
        }
        
        /* ë²„íŠ¼ ìƒ‰ê¹” ì§€ì • */
        #loginBtn { background-color: #007bff; }
        #loginBtn:hover { background-color: #0056b3; }
        
        #downloadBtnOwner, #downloadBtnAdmin { 
            background-color: #28a745; /* ì´ˆë¡ìƒ‰ */
            margin-bottom: 10px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        }
        #downloadBtnOwner:hover, #downloadBtnAdmin:hover { background-color: #218838; }

        /* ì „ ì§€ì  ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #downloadBtnAdminAll { background-color: #17a2b8; } /* íŒŒë‘-ì´ˆë¡ ê³„ì—´ */
        #downloadBtnAdminAll:hover { background-color: #138496; }

        button:disabled { background-color: #aaa; cursor: not-allowed; }
        
        #status {
            margin-top: 20px; font-size: 16px; text-align: center; font-weight: bold; color: #555; padding: 15px; border-radius: 5px; background-color: #eee;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="app">
        <div id="login-view">
            <h1>ìˆ˜í•© ë°ì´í„° ì¶”ì¶œ</h1>
            <div>
                <label for="userid">ì•„ì´ë””:</label>
                <input type="text" id="userid" value="admin">
            </div>
            <div>
                <label for="password">ë¹„ë°€ë²ˆí˜¸:</label>
                <input type="password" id="password">
            </div>
            <button id="loginBtn">ë¡œê·¸ì¸</button>
        </div>

        <div id="owner-view" class="hidden">
            <h1 id="welcome-msg-owner"></h1>
            <p>ë³¸ì¸ ì§€ì ì˜ ìˆ˜í•© ë°ì´í„°ë¥¼ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
            <button id="downloadBtnOwner">ë‚´ ì§€ì  ë°ì´í„° ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div id="admin-view" class="hidden">
            <h1>Admin ë°ì´í„° ì¶”ì¶œ</h1>
            <p><strong>'admin'</strong> ê³„ì •ì…ë‹ˆë‹¤. ì—‘ì…€ë¡œ ì¶”ì¶œí•  ì§€ì ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            <div>
                <label for="branch-select">ì§€ì  ì„ íƒ:</label>
                <select id="branch-select"></select>
            </div>
            <button id="downloadBtnAdmin">ì„ íƒí•œ ì§€ì  ë°ì´í„° ë‹¤ìš´ë¡œë“œ</button>
            
            <button id="downloadBtnAdminAll">ì „ ì§€ì  ë°ì´í„° (ëŒ€í•™ëª… ì—­ìˆœ) ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div id="status">ë¡œê·¸ì¸ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.</div>
    </div>

    <script>
        // [ìˆ˜ì • 1] ë„¤ ì„œë²„ ì£¼ì†Œë¥¼ ì—¬ê¸°ì— ì¶”ê°€!
        const API_BASE_URL = 'https://supermax.kr';

        // ì „ì—­ ë³€ìˆ˜ë¡œ í† í°ê³¼ ìœ ì € ì •ë³´ ì €ì¥
        let appState = {
            token: null,
            user: null
        };

        // DOM ìš”ì†Œ
        const loginView = document.getElementById('login-view');
        const ownerView = document.getElementById('owner-view');
        const adminView = document.getElementById('admin-view');
        const statusEl = document.getElementById('status');
        
        // ë¡œê·¸ì¸ ë²„íŠ¼
        document.getElementById('loginBtn').addEventListener('click', handleLogin);

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        document.getElementById('downloadBtnOwner').addEventListener('click', handleOwnerDownload);
        document.getElementById('downloadBtnAdmin').addEventListener('click', handleAdminDownload);
        // [ì‹ ê·œ] ì „ ì§€ì  ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        document.getElementById('downloadBtnAdminAll').addEventListener('click', handleAdminAllDownload);

        // 1. ë¡œê·¸ì¸ ì²˜ë¦¬
        async function handleLogin() {
            const userid = document.getElementById('userid').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');

            if (!userid || !password) {
                updateStatus("âŒ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.", 'red');
                return;
            }

            btn.disabled = true;
            btn.textContent = "ë¡œê·¸ì¸ ì¤‘...";
            updateStatus("ë¡œê·¸ì¸ ì‹œë„ ì¤‘...", '#333');

            try {
                // [ìˆ˜ì • 2] /26susi/owner_login API ì‚¬ìš©
                const response = await fetch(`${API_BASE_URL}/26susi/owner_login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userid, password })
                });
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
                }

                // ë¡œê·¸ì¸ ì„±ê³µ!
                appState.token = data.token;
                appState.user = parseJwt(data.token); // í† í° ê¹Œì„œ ìœ ì € ì •ë³´ ì €ì¥

                updateStatus("âœ… ë¡œê·¸ì¸ ì„±ê³µ!", 'green');
                showDashboard();

            } catch (err) {
                updateStatus(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${err.message}`, 'red');
                btn.disabled = false;
                btn.textContent = "ë¡œê·¸ì¸";
            }
        }

        // 2. ë¡œê·¸ì¸ í›„ ëŒ€ì‹œë³´ë“œ í‘œì‹œ
        function showDashboard() {
            loginView.classList.add('hidden'); // ë¡œê·¸ì¸ ì°½ ìˆ¨ê¸°ê¸°

            if (appState.user.role === 'admin') {
                // adminì¼ ê²½ìš°
                adminView.classList.remove('hidden');
                updateStatus("Admin ëŒ€ì‹œë³´ë“œ: ì§€ì ì„ ì„ íƒí•˜ì„¸ìš”.", '#333');
                loadAdminBranchList(); // ì§€ì  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            } else {
                // ì¼ë°˜ ownerì¼ ê²½ìš°
                ownerView.classList.remove('hidden');
                document.getElementById('welcome-msg-owner').textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${appState.user.name} ì›ì¥ë‹˜!`;
                updateStatus(`${appState.user.branch} ì§€ì  ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ.`, '#333');
            }
        }
        
        // 3. (Admin ì „ìš©) ì§€ì  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadAdminBranchList() {
            const selectEl = document.getElementById('branch-select');
            selectEl.innerHTML = "<option>ì§€ì  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>";

            try {
                // [ìˆ˜ì • 3] /26susi/branch-data-status APIë¡œ ì§€ì  ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`${API_BASE_URL}/26susi/branch-data-status`, {
                    headers: { 'Authorization': `Bearer ${appState.token}` }
                });
                const data = await response.json();

                if (!data.success) throw new Error("ì§€ì  ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨");

                selectEl.innerHTML = ""; // ì´ˆê¸°í™”
                data.status.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.ì§€ì ëª…;
                    option.textContent = `${branch.ì§€ì ëª…} (í•™ìƒ: ${branch.í•™ìƒ_ìˆ˜}ëª…)`;
                    selectEl.appendChild(option);
                });
            } catch (err) {
                updateStatus(`âŒ ${err.message}`, 'red');
            }
        }

        // 4. (Owner ì „ìš©) ë‹¤ìš´ë¡œë“œ
        async function handleOwnerDownload() {
            const btn = document.getElementById('downloadBtnOwner');
            btn.disabled = true;
            btn.textContent = "ë°ì´í„° ìƒì„± ì¤‘...";
            updateStatus("ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...", '#333');

            try {
                // [ìˆ˜ì • 4] /26susi/branch_summary_by_university API í˜¸ì¶œ
                const response = await fetch(`${API_BASE_URL}/26susi/branch_summary_by_university`, {
                    headers: { 'Authorization': `Bearer ${appState.token}` }
                });
                const data = await response.json();
                if (!data.success) throw new Error("ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨");
                
                await generateExcel(data.universities, appState.user.branch); // ì—‘ì…€ ìƒì„±

            } catch (err) {
                updateStatus(`âŒ ì—ëŸ¬: ${err.message}`, 'red');
            } finally {
                btn.disabled = false;
                btn.textContent = "ë‚´ ì§€ì  ë°ì´í„° ë‹¤ìš´ë¡œë“œ";
            }
        }

        // 5. (Admin ì „ìš©) "ì„ íƒ ì§€ì " ë‹¤ìš´ë¡œë“œ
        async function handleAdminDownload() {
            const btn = document.getElementById('downloadBtnAdmin');
            const selectedBranch = document.getElementById('branch-select').value;
            
            if (!selectedBranch) {
                updateStatus("âŒ ì§€ì ì„ ì„ íƒí•˜ì„¸ìš”.", 'red');
                return;
            }

            btn.disabled = true;
            btn.textContent = "ë°ì´í„° ìƒì„± ì¤‘...";
            updateStatus(`[${selectedBranch}] ì§€ì  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...`, '#333');

            try {
                // [ìˆ˜ì • 5] /26susi/admin/branch_summary API í˜¸ì¶œ
                const response = await fetch(`${API_BASE_URL}/26susi/admin/branch_summary?branch=${selectedBranch}`, {
                    headers: { 'Authorization': `Bearer ${appState.token}` }
                });
                const data = await response.json();
                if (!data.success) throw new Error("ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨");

                await generateExcel(data.universities, selectedBranch); // ì—‘ì…€ ìƒì„±

            } catch (err) {
                updateStatus(`âŒ ì—ëŸ¬: ${err.message}`, 'red');
            } finally {
                btn.disabled = false;
                btn.textContent = "ì„ íƒí•œ ì§€ì  ë°ì´í„° ë‹¤ìš´ë¡œë“œ";
            }
        }

        // [ì‹ ê·œ] 5-1. (Admin ì „ìš©) "ì „ ì§€ì " ë‹¤ìš´ë¡œë“œ
        async function handleAdminAllDownload() {
            const btn = document.getElementById('downloadBtnAdminAll');
            
            btn.disabled = true;
            btn.textContent = "ì „ ì§€ì  ë°ì´í„° ìƒì„± ì¤‘...";
            updateStatus("ì„œë²„ì—ì„œ [ì „ ì§€ì ] ë°ì´í„°ë¥¼ ëª¨ë‘ ê°€ì ¸ì˜¤ëŠ” ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ)", '#333');

            try {
                // [ì‹ ê·œ] 1ë‹¨ê³„ì—ì„œ ë§Œë“  /26susi/admin/all_branch_summary API í˜¸ì¶œ
                const response = await fetch(`${API_BASE_URL}/26susi/admin/all_branch_summary`, {
                    headers: { 'Authorization': `Bearer ${appState.token}` }
                });
                const data = await response.json();
                if (!data.success) throw new Error("ì „ ì§€ì  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨");

                // íŒŒì¼ ì´ë¦„ë§Œ ë‹¤ë¥´ê²Œ í•´ì„œ ì—‘ì…€ ìƒì„±
                await generateExcel(data.universities, "ì „ì§€ì _ëŒ€í•™ëª…ì—­ìˆœ"); 

            } catch (err) {
                updateStatus(`âŒ ì—ëŸ¬: ${err.message}`, 'red');
            } finally {
                btn.disabled = false;
                btn.textContent = "ì „ ì§€ì  ë°ì´í„° (ëŒ€í•™ëª… ì—­ìˆœ) ë‹¤ìš´ë¡œë“œ";
            }
        }

        // 6. (ê³µí†µ) ì—‘ì…€ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        async function generateExcel(universities, branchName) {
            updateStatus("ë°ì´í„° í‰íƒ„í™” ì‘ì—… ì¤‘...", '#333');
            
            const flatData = [];
            universities.forEach(uni => {
                const universityName = uni.ëŒ€í•™ëª…;
                const departmentName = uni.í•™ê³¼ëª…;
                const events = (uni.ì‹¤ê¸°ì¢…ëª© || []);

                uni.í•™ìƒë“¤.forEach(stu => {
                    const studentRow = {
                        "ì§€ì  ì´ë¦„": stu.ì§€ì ëª…,
                        "í•™êµ": stu.í•™êµëª…,
                        "í•™ìƒëª…": stu.ì´ë¦„,
                        "ì„±ë³„": stu.ì„±ë³„,
                        "í•™ë…„": stu.í•™ë…„,
                        "ì§€ì›ëŒ€í•™": universityName,
                        "ì§€ì›ëŒ€í•™ê³¼": departmentName,
                        "ë‚´ì‹ ë“±ê¸‰": stu.ë‚´ì‹ ë“±ê¸‰,
                        "ë‚´ì‹ ì´ì ": stu.ë‚´ì‹ ì ìˆ˜,
                        "ì‹¤ê¸°ì´ì ": stu.ì‹¤ê¸°ì´ì ,
                        "ìˆ˜í•©ì´ì ": stu.í•©ì‚°ì ìˆ˜,
                        "ìµœì´ˆê²°ê³¼": stu.ìµœì´ˆí•©ì—¬ë¶€,
                        "ìµœì¢…ê²°ê³¼": stu.ìµœì¢…í•©ì—¬ë¶€,
                        "ì‹¤ê¸°ì¢…ëª©1": events[0] || null, 
                        "ì‹¤ê¸°ê¸°ë¡1": stu.ê¸°ë¡1,
                        "ì‹¤ê¸°ì ìˆ˜1": stu.ì ìˆ˜1,
                        "ì‹¤ê¸°ì¢…ëª©2": events[1] || null, 
                        "ì‹¤ê¸°ê¸°ë¡2": stu.ê¸°ë¡2,
                        "ì‹¤ê¸°ì ìˆ˜2": stu.ì ìˆ˜2,
                        "ì‹¤ê¸°ì¢…ëª©3": events[2] || null, 
                        "ì‹¤ê¸°ê¸°ë¡3": stu.ê¸°ë¡3,
                        "ì‹¤ê¸°ì ìˆ˜3": stu.ì ìˆ˜3,
                        "ì‹¤ê¸°ì¢…ëª©4": events[3] || null, 
                        "ì‹¤ê¸°ê¸°ë¡4": stu.ê¸°ë¡4,
                        "ì‹¤ê¸°ì ìˆ˜4": stu.ì ìˆ˜4,
                        "ì‹¤ê¸°ì¢…ëª©5": events[4] || null,
                        "ì‹¤ê¸°ê¸°ë¡5": stu.ê¸°ë¡5,
                        "ì‹¤ê¸°ì ìˆ˜5": stu.ì ìˆ˜5,
                        "ì‹¤ê¸°ì¢…ëª©6": events[5] || null,
                        "ì‹¤ê¸°ê¸°ë¡6": stu.ê¸°ë¡6,
                        "ì‹¤ê¸°ì ìˆ˜6": stu.ì ìˆ˜6,
                        "ì‹¤ê¸°ì¢…ëª©7": events[6] || null,
                        "ì‹¤ê¸°ê¸°ë¡7": stu.ê¸°ë¡7,
                        "ì‹¤ê¸°ì ìˆ˜7": stu.ì ìˆ˜7,
                    };
                    
                    flatData.push(studentRow);
                });
            });

            if (flatData.length === 0) {
                updateStatus("âš ï¸ í•´ë‹¹ ì§€ì ì€ ìˆ˜í•©ëœ ë°ì´í„°ê°€ 0ê±´ì…ë‹ˆë‹¤.", 'orange');
                return;
            }

            updateStatus(`ğŸ”„ ${flatData.length}ê°œ í–‰ ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘...`, '#333');

            const worksheet = XLSX.utils.json_to_sheet(flatData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ìµœì¢…ìˆ˜í•©ë°ì´í„°");

            const fileName = `${branchName}_ìµœì¢…ìˆ˜í•©ë°ì´í„°_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);

            updateStatus(`ğŸ‰ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì„±ê³µ! (${fileName})`, 'green');
        }

        // 7. (ê³µí†µ) ìƒíƒœ ì—…ë°ì´íŠ¸ ìœ í‹¸
        function updateStatus(message, color) {
            statusEl.textContent = message;
            statusEl.style.color = color;
        }

        // 8. (ê³µí†µ) JWT í† í° ë””ì½”ë” (btoa/atob ì‚¬ìš©)
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("JWT ë””ì½”ë”© ì‹¤íŒ¨", e);
                return null;
            }
        }

    </script>
</body>
</html>