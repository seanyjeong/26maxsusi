<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€ì ë³„ ìµœì¢… ìˆ˜í•© í˜„í™©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary-color: #4364f7; --secondary-color: #6a8eff; --dark-gray: #495057; --light-gray: #f8f9fa; --medium-gray: #e9ecef; --border-radius: 8px;}
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--light-gray); padding: 20px; }
        .container { max-width: 95%; margin: 0 auto; }
        h2 { color: var(--primary-color); }
        .university-accordion details { background: white; border-radius: var(--border-radius); margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .university-accordion summary { padding: 15px 20px; font-size: 1.2em; font-weight: 500; cursor: pointer; color: var(--dark-gray); display: flex; justify-content: space-between; align-items: center; }
        .university-accordion summary:hover { background-color: #fdfdff; }
        .summary-info { font-size: 0.8em; font-weight: 400; color: #555; }
        .table-container { padding: 0 20px 20px 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid var(--medium-gray); padding: 8px; text-align: center; font-size: 12px; white-space: nowrap; }
        th { background-color: var(--primary-color); color: white; font-weight: 500; position: sticky; top: 0; z-index: 1; }
        input { width: 95%; box-sizing: border-box; text-align: center; border: 1px solid var(--medium-gray); border-radius: 4px; padding: 4px; font-size: 12px; }
        .practical-input-group { display: flex; align-items: center; justify-content: center; gap: 4px; }
        .input-record { width: 60px; }
        .input-score-only { width: 40px; background-color: #f0f0f0; border: none; }
        .gam-span, .total-gam-span { color: red; font-size: 11px; font-weight: bold; margin-left: 4px; }
        .save-button-container { text-align: right; margin-top: 15px; }
        .btn-save { padding: 8px 15px; background-color: var(--dark-gray); color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-save:hover { background-color: #333; }
                .btn-check {
            background-color: #ffc107;
            color: #212529;
            font-weight: 500;
            padding: 8px 15px;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 id="main-title">ìš°ë¦¬ ì§€ì  ìµœì¢… ìˆ˜í•© í˜„í™©</h2>
    
    <div style="margin-bottom: 20px;">
        <button class="btn-check" onclick="checkUnassignedStudents()">ì•„ì§ ìˆ˜í•© ì•ˆëœ í•™ìƒ í™•ì¸</button>
    </div>
    <div class="university-accordion" id="university-accordion">
        </div>
</div>

<script>
    const SERVER = 'https://supermax.kr';
    const token = localStorage.getItem('token');
    if (!token) location.href = 'login.html';
    let allUniversityData = [];

    window.onload = async () => {
        Swal.fire({ title: 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        try {
            const res = await fetch(`${SERVER}/26susi/branch_summary_by_university`, { headers: { 'Authorization': 'Bearer ' + token } });
            if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);
            const data = await res.json();
            
            if (data.success) {
                allUniversityData = data.universities;
                renderAccordions(allUniversityData);
            } else {
                throw new Error(data.message || 'ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            Swal.fire('ì˜¤ë¥˜', `ë°ì´í„° ì¡°íšŒ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        } finally {
            Swal.close();
        }
    };

    function renderAccordions(universities) {
        const accordionContainer = document.getElementById('university-accordion');
        accordionContainer.innerHTML = '';
        if (universities.length === 0) {
            accordionContainer.innerHTML = '<p>ì•„ì§ ìˆ˜í•©ëœ ëŒ€í•™ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        universities.forEach(uni => {
            const details = document.createElement('details');
            details.dataset.collegeId = uni.ëŒ€í•™ID;
            details.innerHTML = `
                <summary>
                    ${uni.ëŒ€í•™ëª…} - ${uni.í•™ê³¼ëª…} (${uni.ì „í˜•ëª…})
                    <span class="summary-info">ì´ ${uni.í•™ìƒë“¤.length}ëª…</span>
                </summary>
                <div class="table-container"></div>
            `;
            accordionContainer.appendChild(details);

            details.querySelector('summary').addEventListener('click', () => {
                if (!details.open) {
                    const tableContainer = details.querySelector('.table-container');
                    if (tableContainer.children.length === 0) {
                        renderUniversityTable(tableContainer, uni);
                    }
                }
            });
        });
    }

    function renderUniversityTable(container, universityData) {
        const events = universityData.ì‹¤ê¸°ì¢…ëª© || [];
        let tableHTML = `
            <table>
                <thead>
                    <tr>
                        <th>ì´ë¦„</th><th>í•™ë…„</th><th>ì„±ë³„</th><th>ë“±ê¸‰</th><th>ë‚´ì‹ ì ìˆ˜</th>
                        ${events.map(e => `<th>${e}</th>`).join('')}
                        <th>ì‹¤ê¸°ì´ì </th><th>í•©ì‚°ì ìˆ˜</th><th>ì‹¤ê¸°ì¼ì •</th><th>ìµœì´ˆí•©</th><th>ìµœì¢…í•©</th>
                    </tr>
                </thead>
                <tbody>
                    ${universityData.í•™ìƒë“¤.map(student => {
                        const scheduleDate = student.ì‹¤ê¸°ì¼ì • ? student.ì‹¤ê¸°ì¼ì •.split(' ')[0] : '';
                        return `
                            <tr data-student-id="${student.í•™ìƒID}">
                                <td>${student.ì´ë¦„}</td><td>${student.í•™ë…„}</td><td>${student.ì„±ë³„}</td>
                                <td><input class="input-grade" type="text" value="${student.ë‚´ì‹ ë“±ê¸‰ || ''}" oninput="onNaesinInputChange(this)"></td>
                                <td><input class="input-score" type="text" value="${student.ë‚´ì‹ ì ìˆ˜ || ''}" oninput="onNaesinInputChange(this)"></td>
                                ${events.map((eventName, i) => `
                                    <td><div class="practical-input-group">
                                        <input type="text" class="input-record" data-event-name="${eventName}" value="${student[`ê¸°ë¡${i+1}`] || ''}" oninput="onRecordInputChange(this)" placeholder="ê¸°ë¡">
                                        <input type="text" class="input-score-only" value="${student[`ì ìˆ˜${i+1}`] || ''}" readonly>
                                    </div></td>
                                `).join('')}
                                <td class="total-score-cell">${student.ì‹¤ê¸°ì´ì  !== null ? student.ì‹¤ê¸°ì´ì .toFixed(2) : '-'}</td>
                                <td class="total-sum-cell">${student.í•©ì‚°ì ìˆ˜ !== null ? student.í•©ì‚°ì ìˆ˜.toFixed(2) : '-'}</td>
                                <td><input class="input-date" type="date" value="${scheduleDate || ''}"></td>
                                <td><input class="input-first-pass" type="text" value="${student.ìµœì´ˆí•©ì—¬ë¶€ || ''}" placeholder="í•©/ë¶ˆ/ì˜ˆë¹„"></td>
                                <td><input class="input-final-pass" type="text" value="${student.ìµœì¢…í•©ì—¬ë¶€ || ''}" placeholder="í•©/ë¶ˆ/ì˜ˆë¹„"></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            <div class="save-button-container">
                <button class="btn-save" onclick="saveUniversityData(this)">${universityData.ëŒ€í•™ëª…} ì €ì¥</button>
            </div>
        `;
        container.innerHTML = tableHTML;
        container.querySelectorAll('tbody tr').forEach(row => updateScoresForRow(row));
    }

    async function saveUniversityData(button) {
        const detailsElement = button.closest('details');
        const collegeId = parseInt(detailsElement.dataset.collegeId, 10);
        
        // âœ… [ì•ˆì •ì„± ê°•í™”] universityDataë¥¼ ì°¾ì§€ ëª»í•˜ë©´ ì¦‰ì‹œ ì¤‘ë‹¨
        const universityData = allUniversityData.find(uni => uni.ëŒ€í•™ID == collegeId);
        if (!universityData) {
            Swal.fire('ì €ì¥ ì˜¤ë¥˜', 'ì €ì¥í•  ëŒ€í•™ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }
        
        Swal.fire({ title: `${universityData.ëŒ€í•™ëª…} ì €ì¥ ì¤‘...`, allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const studentDataPayload = [];
        detailsElement.querySelectorAll('tbody tr[data-student-id]').forEach(row => {
            const data = {
                í•™ìƒID: parseInt(row.dataset.studentId, 10),
                ì‹¤ê¸°ID: universityData.ì‹¤ê¸°ID,
                ë‚´ì‹ ë“±ê¸‰: row.querySelector('.input-grade').value,
                ë‚´ì‹ ì ìˆ˜: row.querySelector('.input-score').value,
                ì‹¤ê¸°ì´ì : parseFloat(row.querySelector('.total-score-cell').textContent) || null,
                í•©ì‚°ì ìˆ˜: parseFloat(row.querySelector('.total-sum-cell').textContent) || null,
                ì‹¤ê¸°ì¼ì •: row.querySelector('.input-date').value || null,
                ìµœì´ˆí•©ì—¬ë¶€: row.querySelector('.input-first-pass').value,
                ìµœì¢…í•©ì—¬ë¶€: row.querySelector('.input-final-pass').value,
            };
            row.querySelectorAll('.input-record').forEach((inp, i) => {
                data[`ê¸°ë¡${i+1}`] = inp.value || null;
                data[`ì ìˆ˜${i+1}`] = inp.nextElementSibling.value || null;
            });
            studentDataPayload.push(data);
        });
        
        try {
            const res = await fetch(`${SERVER}/26susi_final_save`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ college_id: collegeId, studentData: studentDataPayload })
            });
            if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);
            const result = await res.json();
            
            if (result.success) Swal.fire('ì €ì¥ ì™„ë£Œ!', `${universityData.ëŒ€í•™ëª…} ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            else throw new Error(result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');

        } catch (error) {
            Swal.fire('ì €ì¥ ì‹¤íŒ¨', `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        }
    }

    // âœ… [ì•ˆì •ì„± ê°•í™”] ì ìˆ˜ ê³„ì‚° ë° ì—…ë°ì´íŠ¸ ë¡œì§ (try-catch ë° íƒ€ì… ë¹„êµ ë¬¸ì œ í•´ê²°)
    async function updateScoresForRow(row) {
        try {
            const studentId = parseInt(row.dataset.studentId, 10);
            const collegeId = parseInt(row.closest('details').dataset.collegeId, 10);
            
            // íƒ€ì… ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ '==' ì‚¬ìš©
            const university = allUniversityData.find(uni => uni.ëŒ€í•™ID == collegeId);

            if (!university) return; // ëŒ€í•™ ì •ë³´ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ì¢…ë£Œ

            const student = university.í•™ìƒë“¤.find(s => s.í•™ìƒID == studentId);

            if (!student || !university.ì‹¤ê¸°ID) return;

            const res = await fetch(`${SERVER}/26susi/calculate-final-score`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ëŒ€í•™ID: university.ëŒ€í•™ID,
                    gender: student.ì„±ë³„,
                    inputs: Array.from(row.querySelectorAll('input.input-record')).map(inp => ({ ì¢…ëª©ëª…: inp.dataset.eventName, ê¸°ë¡: inp.value.trim() || null })),
                    ë‚´ì‹ ì ìˆ˜: row.querySelector('.input-score').value || 0
                })
            });
            if (!res.ok) throw new Error(`ì ìˆ˜ ê³„ì‚° ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);
            const data = await res.json();

            if (data.success) {
                row.querySelectorAll('input.input-record').forEach(recordInput => {
                    const eventName = recordInput.dataset.eventName;
                    recordInput.nextElementSibling.value = data.ì¢…ëª©ë³„ì ìˆ˜[eventName];
                });
                row.querySelector('.total-score-cell').textContent = data.ì‹¤ê¸°ì´ì .toFixed(2);
                row.querySelector('.total-sum-cell').textContent = data.í•©ì‚°ì ìˆ˜.toFixed(2);
            } else {
                // ì„œë²„ê°€ success:falseë¥¼ ë³´ëƒˆì„ ê²½ìš° ì½˜ì†”ì— ë¡œê·¸
                console.error('ì ìˆ˜ ê³„ì‚° ì‹¤íŒ¨:', data.message);
            }
        } catch (error) {
            // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“± fetch ìì²´ê°€ ì‹¤íŒ¨í–ˆì„ ê²½ìš°
            console.error('ì ìˆ˜ ì—…ë°ì´íŠ¸ ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
        }
    }
      async function checkUnassignedStudents() {
        Swal.fire({ title: 'í™•ì¸ ì¤‘...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        try {
            // 1. ì„œë²„ì— ë§Œë“  ìƒˆ APIë¥¼ í˜¸ì¶œ
            const res = await fetch(`${SERVER}/26susi/unassigned_students`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();

            if (!data.success) {
                throw new Error(data.message || 'ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
            }

            // 2. ê²°ê³¼ë¥¼ ë°›ì•„ì„œ íŒì—…ìœ¼ë¡œ ë³´ì—¬ì¤Œ
            let contentHTML = '';
            if (data.students.length === 0) {
                contentHTML = '<p>ëª¨ë“  í•™ìƒì´ ìµœì†Œ 1ê°œ ì´ìƒì˜ ëŒ€í•™ì— ìˆ˜í•©ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰</p>';
            } else {
                contentHTML = `<p>ì´ ${data.students.length}ëª…ì˜ í•™ìƒì´ ì•„ì§ ì–´ë–¤ ëŒ€í•™ì—ë„ í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                               <ul style="text-align: left; max-height: 300px; overflow-y: auto;">` +
                               data.students.map(s => `<li>${s.ì´ë¦„} (${s.í•™ë…„}í•™ë…„)</li>`).join('') +
                               `</ul>`;
            }

            Swal.fire({
                title: 'ë¯¸ìˆ˜í•© í•™ìƒ ëª…ë‹¨',
                html: contentHTML,
                icon: data.students.length === 0 ? 'success' : 'info'
            });

        } catch (error) {
            Swal.fire('ì˜¤ë¥˜', `ë¯¸ìˆ˜í•© í•™ìƒì„ í™•ì¸í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        }
    }  
    
    function onRecordInputChange(input) { updateScoresForRow(input.closest('tr')); }
    function onNaesinInputChange(input) { updateScoresForRow(input.closest('tr')); }
</script>
</body>
</html>
