<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì§€ì ë³„ ìµœì¢… ìˆ˜í•© í˜„í™©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary-color: #4364f7; --secondary-color: #6a8eff; --dark-gray: #495057; --light-gray: #f8f9fa; --medium-gray: #e9ecef; --border-radius: 8px;}
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--light-gray); padding: 20px; }
        .container { max-width: 95%; margin: 0 auto; }
        h2 { color: var(--primary-color); }
        .university-accordion details { background: white; border-radius: var(--border-radius); margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .university-accordion summary { padding: 15px 20px; font-size: 1.2em; font-weight: 500; cursor: pointer; color: var(--dark-gray); display: flex; justify-content: space-between; align-items: center; }
        .university-accordion summary:hover { background-color: #fdfdff; }
        .summary-title { display: flex; align-items: center; gap: 10px; }
        .summary-info { font-size: 0.8em; font-weight: 400; color: #555; }
        .table-container { padding: 0 20px 20px 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid var(--medium-gray); padding: 8px; text-align: center; font-size: 12px; white-space: nowrap; vertical-align: middle; }
        th { background-color: var(--primary-color); color: white; font-weight: 500; position: sticky; top: 0; z-index: 1; }
        input, select, button { box-sizing: border-box; font-family: 'Noto Sans KR', sans-serif; border: 1px solid var(--medium-gray); border-radius: 4px; padding: 4px; font-size: 12px; }
        input { width: 95%; text-align: center; }
        select { width: 100%; text-align: left; padding: 4px 2px; }
        button { cursor: pointer; }
        .practical-input-group { display: flex; align-items: center; justify-content: center; gap: 4px; }
        .input-record { width: 60px; }
        .input-score-only { width: 40px; background-color: #f0f0f0; border: none; }
        .save-button-container { text-align: right; margin-top: 15px; }
        .btn-save { padding: 8px 15px; background-color: var(--dark-gray); color: white; border: none; }
        .btn-check { background-color: #ffc107; color: #212529; font-weight: 500; padding: 8px 15px; border: none; }
        .pass-fail-container { display: flex; align-items: center; gap: 5px; min-width: 150px; }
        .input-reserve-number { width: 60px !important; text-align: center; }
        .btn-score-table { font-size: 11px; padding: 3px 8px; background-color: var(--secondary-color); color: white; border: none; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: var(--border-radius); width: 90%; max-width: 1200px; position: relative; }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: black; }
        #modalTitle { margin-bottom: 20px; color: var(--primary-color); }
        #modalTableContainer { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px; }
        #modalTableContainer table { min-width: 300px; }
    </style>
</head>
<body>
<div class="container">
    <h2 id="main-title">(êµìœ¡ì›ëª…) êµìœ¡ì› ìµœì¢…ìˆ˜í•©(ì‹¤ê¸°í¬í•¨)</h2>
    <div style="margin-bottom: 20px;">
        <button class="btn-check" onclick="checkUnassignedStudents()">ì•„ì§ ìˆ˜í•© ì•ˆëœ í•™ìƒ í™•ì¸</button>
    </div>
    <div class="university-accordion" id="university-accordion"></div>
</div>

<div id="scoreTableModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3 id="modalTitle"></h3>
        <div id="modalTableContainer"></div>
    </div>
</div>

<script>
    const SERVER = 'https://supermax.kr';
    const token = localStorage.getItem('token');
    if (!token) location.href = 'login.html';
    let allUniversityData = [];

    window.onload = async () => {
        Swal.fire({ title: 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        try {
            const [summaryRes, profileRes] = await Promise.all([
                fetch(`${SERVER}/26susi/branch_summary_by_university`, { headers: { 'Authorization': 'Bearer ' + token } }),
                fetch(`${SERVER}/26susi/profile`, { headers: { 'Authorization': 'Bearer ' + token } })
            ]);
            if (!summaryRes.ok || !profileRes.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜`);
            const summaryData = await summaryRes.json();
            const profileData = await profileRes.json();

            if (profileData.success && profileData.user) {
                document.getElementById('main-title').textContent = `${profileData.user.branch} êµìœ¡ì› ìµœì¢…ìˆ˜í•©(ì‹¤ê¸°í¬í•¨)`;
            }

            if (summaryData.success) {
                allUniversityData = summaryData.universities;
                renderAccordions(allUniversityData);
            } else {
                throw new Error(summaryData.message || 'ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            Swal.fire('ì˜¤ë¥˜', `ë°ì´í„° ì¡°íšŒ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        } finally {
            Swal.close();
        }
    };

    function renderAccordions(universities) {
        const accordionContainer = document.getElementById('university-accordion');
        accordionContainer.innerHTML = '';
        if (universities.length === 0) {
            accordionContainer.innerHTML = '<p>ì•„ì§ ìˆ˜í•©ëœ ëŒ€í•™ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        universities.forEach(uni => {
            const details = document.createElement('details');
            details.dataset.collegeId = uni.ëŒ€í•™ID;
            details.innerHTML = `
                <summary>
                    <div class="summary-title">
                        <span>${uni.ëŒ€í•™ëª…} - ${uni.í•™ê³¼ëª…} (${uni.ì „í˜•ëª…})</span>
                        ${uni.ì‹¤ê¸°ID ? `<button class="btn-score-table" onclick="event.stopPropagation(); openScoreTablePopup(this)">ë°°ì í‘œ</button>` : ''}
                    </div>
                    <span class="summary-info">ì´ ${uni.í•™ìƒë“¤.length}ëª…</span>
                </summary>
                <div class="table-container"></div>
            `;
            accordionContainer.appendChild(details);
            details.querySelector('summary').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') return;
                if (!details.open) {
                    const tableContainer = details.querySelector('.table-container');
                    if (tableContainer.children.length === 0) {
                        renderUniversityTable(tableContainer, uni);
                    }
                }
            });
        });
    }

    function renderUniversityTable(container, universityData) {
        const events = universityData.ì‹¤ê¸°ì¢…ëª© || [];
        
        universityData.í•™ìƒë“¤.sort((a, b) => (b.í•©ì‚°ì ìˆ˜ || 0) - (a.í•©ì‚°ì ìˆ˜ || 0));

        const tableHTML = `
            <div id="table-wrapper-${universityData.ëŒ€í•™ID}">
                <table>
                    <thead>
                        <tr>
                            <th>ì´ë¦„</th><th>í•™ë…„</th><th>ì„±ë³„</th><th>ë“±ê¸‰</th><th>ë‚´ì‹ ì ìˆ˜</th>
                            ${events.map(e => `<th>${e}</th>`).join('')}
                            <th>ì‹¤ê¸°ì´ì </th><th>í•©ì‚°ì ìˆ˜</th><th>ì‹¤ê¸°ì¼ì •</th><th>ìµœì´ˆí•©</th><th>ìµœì¢…í•©</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${universityData.í•™ìƒë“¤.map(student => {
                            const parsePassData = (value) => {
                                if (!value) return { status: '', number: '' };
                                if (value.startsWith('ì˜ˆë¹„')) return { status: 'ì˜ˆë¹„', number: value.replace('ì˜ˆë¹„', '') };
                                return { status: value, number: '' };
                            };
                            const firstPass = parsePassData(student.ìµœì´ˆí•©ì—¬ë¶€);
                            const finalPass = parsePassData(student.ìµœì¢…í•©ì—¬ë¶€);
                            const scheduleDate = student.ì‹¤ê¸°ì¼ì • ? student.ì‹¤ê¸°ì¼ì •.split(' ')[0] : '';
                            
                            return `
                                <tr data-student-id="${student.í•™ìƒID}">
                                    <td>${student.ì´ë¦„}</td><td>${student.í•™ë…„}</td><td>${student.ì„±ë³„}</td>
                                    <td><input class="input-grade" type="text" value="${student.ë‚´ì‹ ë“±ê¸‰ || ''}" oninput="onNaesinInputChange(this)"></td>
                                    <td><input class="input-score" type="text" value="${student.ë‚´ì‹ ì ìˆ˜ || ''}" oninput="onNaesinInputChange(this)"></td>
                                    ${events.map((eventName, i) => `
                                        <td><div class="practical-input-group">
                                            <input type="text" class="input-record" data-event-name="${eventName}" value="${student[`ê¸°ë¡${i+1}`] || ''}" oninput="onRecordInputChange(this)" placeholder="ê¸°ë¡">
                                            <input type="text" class="input-score-only" value="${student[`ì ìˆ˜${i+1}`] || ''}" readonly>
                                        </div></td>
                                    `).join('')}
                                    <td class="total-score-cell">${student.ì‹¤ê¸°ì´ì  !== null ? student.ì‹¤ê¸°ì´ì .toFixed(2) : '-'}</td>
                                    <td class="total-sum-cell">${student.í•©ì‚°ì ìˆ˜ !== null ? student.í•©ì‚°ì ìˆ˜.toFixed(2) : '-'}</td>
                                    <td><input class="input-date" type="date" value="${scheduleDate || ''}"></td>
                                    <td>
                                        <div class="pass-fail-container">
                                            <select class="select-pass-status" onchange="handlePassStatusChange(this)">
                                                <option value="" ${firstPass.status === '' ? 'selected' : ''}>ì„ íƒ</option>
                                                <option value="1ì°¨í•©ê²©" ${firstPass.status === '1ì°¨í•©ê²©' ? 'selected' : ''}>1ì°¨í•©ê²©</option>
                                                <option value="í•©ê²©" ${firstPass.status === 'í•©ê²©' ? 'selected' : ''}>í•©ê²©</option>
                                                <option value="ë¶ˆí•©ê²©" ${firstPass.status === 'ë¶ˆí•©ê²©' ? 'selected' : ''}>ë¶ˆí•©ê²©</option>
                                                <option value="ì˜ˆë¹„" ${firstPass.status === 'ì˜ˆë¹„' ? 'selected' : ''}>ì˜ˆë¹„</option>
                                            </select>
                                            <input type="number" class="input-reserve-number" value="${firstPass.number}" style="display: ${firstPass.status === 'ì˜ˆë¹„' ? 'block' : 'none'};" placeholder="ë²ˆí˜¸">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="pass-fail-container">
                                            <select class="select-pass-status" onchange="handlePassStatusChange(this)">
                                                <option value="" ${finalPass.status === '' ? 'selected' : ''}>ì„ íƒ</option>
                                                <option value="ìµœì €ë¶ˆí•©ê²©" ${finalPass.status === 'ìµœì €ë¶ˆí•©ê²©' ? 'selected' : ''}>ìµœì €ë¶ˆí•©ê²©</option>
                                                <option value="í•©ê²©" ${finalPass.status === 'í•©ê²©' ? 'selected' : ''}>í•©ê²©</option>
                                                <option value="ë¶ˆí•©ê²©" ${finalPass.status === 'ë¶ˆí•©ê²©' ? 'selected' : ''}>ë¶ˆí•©ê²©</option>
                                                <option value="ì˜ˆë¹„" ${finalPass.status === 'ì˜ˆë¹„' ? 'selected' : ''}>ì˜ˆë¹„</option>
                                            </select>
                                            <input type="number" class="input-reserve-number" value="${finalPass.number}" style="display: ${finalPass.status === 'ì˜ˆë¹„' ? 'block' : 'none'};" placeholder="ë²ˆí˜¸">
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <div class="save-button-container">
                    <button class="btn-save" onclick="saveUniversityData(this)">${universityData.ëŒ€í•™ëª…} ì €ì¥</button>
                </div>
            </div>
        `;
        container.innerHTML = tableHTML;
    }

    async function saveUniversityData(button) {
        const detailsElement = button.closest('details');
        const collegeId = parseInt(detailsElement.dataset.collegeId, 10);
        
        const universityData = allUniversityData.find(uni => uni.ëŒ€í•™ID == collegeId);
        if (!universityData) {
            Swal.fire('ì €ì¥ ì˜¤ë¥˜', 'ì €ì¥í•  ëŒ€í•™ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        let incompleteReserve = false;
        detailsElement.querySelectorAll('.pass-fail-container').forEach(container => {
            if (container.querySelector('.select-pass-status').value === 'ì˜ˆë¹„' && !container.querySelector('.input-reserve-number').value) {
                incompleteReserve = true;
            }
        });
        if (incompleteReserve) {
            Swal.fire('ì…ë ¥ ì˜¤ë¥˜', '"ì˜ˆë¹„"ë¥¼ ì„ íƒí•œ ê²½ìš°, ë°˜ë“œì‹œ ì˜ˆë¹„ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'warning');
            return;
        }

        Swal.fire({ title: `${universityData.ëŒ€í•™ëª…} ì €ì¥ ì¤‘...`, allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const studentDataPayload = [];
        detailsElement.querySelectorAll('tbody tr[data-student-id]').forEach(row => {
            const getPassValue = (container) => {
                const status = container.querySelector('.select-pass-status').value;
                const number = container.querySelector('.input-reserve-number').value;
                if (status === 'ì˜ˆë¹„' && number) return `ì˜ˆë¹„${number}`;
                return status;
            };
            const data = {
                í•™ìƒID: parseInt(row.dataset.studentId, 10), ì‹¤ê¸°ID: universityData.ì‹¤ê¸°ID,
                ë‚´ì‹ ë“±ê¸‰: row.querySelector('.input-grade').value, ë‚´ì‹ ì ìˆ˜: row.querySelector('.input-score').value,
                ì‹¤ê¸°ì´ì : parseFloat(row.querySelector('.total-score-cell').textContent) || null,
                í•©ì‚°ì ìˆ˜: parseFloat(row.querySelector('.total-sum-cell').textContent) || null,
                ì‹¤ê¸°ì¼ì •: row.querySelector('.input-date').value || null,
                ìµœì´ˆí•©ì—¬ë¶€: getPassValue(row.querySelectorAll('.pass-fail-container')[0]),
                ìµœì¢…í•©ì—¬ë¶€: getPassValue(row.querySelectorAll('.pass-fail-container')[1]),
            };
            row.querySelectorAll('.input-record').forEach((inp, i) => {
                data[`ê¸°ë¡${i+1}`] = inp.value || null;
                data[`ì ìˆ˜${i+1}`] = inp.nextElementSibling.value || null;
            });
            studentDataPayload.push(data);
        });
        
        try {
            const res = await fetch(`${SERVER}/26susi_final_save`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ college_id: collegeId, studentData: studentDataPayload })
            });
            if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);
            const result = await res.json();
            
            if (result.success) {
                await Swal.fire('ì €ì¥ ì™„ë£Œ!', `${universityData.ëŒ€í•™ëª…} ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                
                // 1. ì €ì¥ëœ ìµœì‹  ì •ë³´ë¡œ ì „ì—­ ë°ì´í„°(allUniversityData)ë¥¼ ì—…ë°ì´íŠ¸
                const university = allUniversityData.find(uni => uni.ëŒ€í•™ID == collegeId);
                if(university) {
                    university.í•™ìƒë“¤ = studentDataPayload.map(payload => {
                        const originalStudent = university.í•™ìƒë“¤.find(s => s.í•™ìƒID == payload.í•™ìƒID);
                        return {...originalStudent, ...payload}; // ê¸°ì¡´ ì •ë³´ì— ìƒˆ ì •ë³´ë¥¼ ë®ì–´ì“°ê¸°
                    });
                }
                
                // 2. í•´ë‹¹ ëŒ€í•™ì˜ í…Œì´ë¸” ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì•„ì„œ ë‹¤ì‹œ ë Œë”ë§ (ì¬ì •ë ¬)
                const tableContainer = document.querySelector(`#table-wrapper-${collegeId}`).parentElement;
                renderUniversityTable(tableContainer, university);

            } else {
                throw new Error(result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            Swal.fire('ì €ì¥ ì‹¤íŒ¨', `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        }
    }

    async function updateScoresForRow(row) {
        try {
            const studentId = parseInt(row.dataset.studentId, 10);
            const collegeId = parseInt(row.closest('details').dataset.collegeId, 10);
            const university = allUniversityData.find(uni => uni.ëŒ€í•™ID == collegeId);
            if (!university) return;
            const student = university.í•™ìƒë“¤.find(s => s.í•™ìƒID == studentId);
            if (!student || !university.ì‹¤ê¸°ID) {
                // ì‹¤ê¸° ì—†ëŠ” ì „í˜•ì€ ë‚´ì‹ ì ìˆ˜ê°€ í•©ì‚°ì ìˆ˜ê°€ ë¨
                const naesinScore = parseFloat(row.querySelector('.input-score').value) || 0;
                row.querySelector('.total-sum-cell').textContent = naesinScore.toFixed(2);
                return;
            }

            const res = await fetch(`${SERVER}/26susi/calculate-final-score`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ëŒ€í•™ID: university.ëŒ€í•™ID, gender: student.ì„±ë³„,
                    inputs: Array.from(row.querySelectorAll('input.input-record')).map(inp => ({ ì¢…ëª©ëª…: inp.dataset.eventName, ê¸°ë¡: inp.value.trim() || null })),
                    ë‚´ì‹ ì ìˆ˜: row.querySelector('.input-score').value || 0
                })
            });
            if (!res.ok) throw new Error(`ì ìˆ˜ ê³„ì‚° ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);
            const data = await res.json();
            
            if (data.success) {
                // í–‰ ì „ì²´ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” ëŒ€ì‹ , ì ìˆ˜ ì¹¸ì˜ ë‚´ìš©ë§Œ ì§ì ‘ ì—…ë°ì´íŠ¸
                row.querySelectorAll('input.input-record').forEach(recordInput => {
                    const eventName = recordInput.dataset.eventName;
                    recordInput.nextElementSibling.value = data.ì¢…ëª©ë³„ì ìˆ˜[eventName];
                });
                row.querySelector('.total-score-cell').textContent = data.ì‹¤ê¸°ì´ì .toFixed(2);
                row.querySelector('.total-sum-cell').textContent = data.í•©ì‚°ì ìˆ˜.toFixed(2);
            } else {
                console.error('ì ìˆ˜ ê³„ì‚° ì‹¤íŒ¨:', data.message);
            }
        } catch (error) {
            console.error('ì ìˆ˜ ì—…ë°ì´íŠ¸ ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
        }
    }
    
    function onRecordInputChange(input) { updateScoresForRow(input.closest('tr')); }
    function onNaesinInputChange(input) { updateScoresForRow(input.closest('tr')); }

    function handlePassStatusChange(selectElement) {
        const numberInput = selectElement.nextElementSibling;
        if (selectElement.value === 'ì˜ˆë¹„') {
            numberInput.style.display = 'block';
            numberInput.focus();
        } else {
            numberInput.style.display = 'none';
            numberInput.value = '';
        }
    }
    
    async function checkUnassignedStudents() {
        Swal.fire({ title: 'í™•ì¸ ì¤‘...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        try {
            const res = await fetch(`${SERVER}/26susi/unassigned_students`, { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();
            if (!data.success) throw new Error(data.message || 'ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
            let contentHTML = '';
            if (data.students.length === 0) {
                contentHTML = '<p>ëª¨ë“  í•™ìƒì´ ìµœì†Œ 1ê°œ ì´ìƒì˜ ëŒ€í•™ì— ìˆ˜í•©ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰</p>';
            } else {
                contentHTML = `<p>ì´ ${data.students.length}ëª…ì˜ í•™ìƒì´ ì•„ì§ ì–´ë–¤ ëŒ€í•™ì—ë„ í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                               <ul style="text-align: left; max-height: 300px; overflow-y: auto;">` +
                               data.students.map(s => `<li>${s.ì´ë¦„} (${s.í•™ë…„}í•™ë…„)</li>`).join('') +
                               `</ul>`;
            }
            Swal.fire({ title: 'ë¯¸ìˆ˜í•© í•™ìƒ ëª…ë‹¨', html: contentHTML, icon: data.students.length === 0 ? 'success' : 'info' });
        } catch (error) {
            Swal.fire('ì˜¤ë¥˜', `ë¯¸ìˆ˜í•© í•™ìƒì„ í™•ì¸í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        }
    }

    async function openScoreTablePopup(button) {
        const detailsElement = button.closest('details');
        const collegeId = parseInt(detailsElement.dataset.collegeId, 10);
        const university = allUniversityData.find(uni => uni.ëŒ€í•™ID == collegeId);
        if (!university || !university.ì‹¤ê¸°ID) {
            Swal.fire('ì•Œë¦¼', 'í•´ë‹¹ ëŒ€í•™ì˜ ì‹¤ê¸° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }
        const modal = document.getElementById('scoreTableModal');
        document.getElementById('modalTitle').textContent = `${university.ëŒ€í•™ëª…} - ${university.í•™ê³¼ëª…} ë°°ì í‘œ`;
        const container = document.getElementById('modalTableContainer');
        container.innerHTML = 'ë¡œë”© ì¤‘...';
        modal.style.display = 'block';
        
        try {
            const res = await fetch(`${SERVER}/26susi_get_score_table?ì‹¤ê¸°ID=${university.ì‹¤ê¸°ID}`);
            const data = await res.json();
            if (data.success) {
                renderPopupScoreTable(data.events, container);
            } else {
                container.innerHTML = 'ë°°ì í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || '');
            }
        } catch(e) {
            container.innerHTML = 'ë°°ì í‘œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.';
        }
    }

    function renderPopupScoreTable(events, container) {
        let finalHTML = '';
        Object.keys(events).forEach(name => {
            const { ë‚¨, ì—¬ } = events[name];
            const allScores = new Set([...ë‚¨.map(i => i.ë°°ì ), ...ì—¬.map(i => i.ë°°ì )]);
            const sortedScores = Array.from(allScores).sort((a,b) => {
                const numA = parseFloat(a); const numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numB - numA;
                return a > b ? -1 : 1;
            });
            const scoreMap = { ë‚¨: new Map(ë‚¨.map(i => [i.ë°°ì , i.ê¸°ë¡])), ì—¬: new Map(ì—¬.map(i => [i.ë°°ì , i.ê¸°ë¡])) };
            let tableHTML = `<table><thead><tr><th colspan="3">${name}</th></tr><tr><th>ë°°ì </th><th>ë‚¨</th><th>ì—¬</th></tr></thead><tbody>`;
            sortedScores.forEach(score => { tableHTML += `<tr><td>${score}</td><td>${scoreMap.ë‚¨.get(score) || '-'}</td><td>${scoreMap.ì—¬.get(score) || '-'}</td></tr>`; });
            tableHTML += '</tbody></table>';
            finalHTML += tableHTML;
        });
        container.innerHTML = finalHTML;
    }

    document.querySelector('#scoreTableModal .close-btn').onclick = () => {
        document.getElementById('scoreTableModal').style.display = 'none';
    };
</script>
</body>
</html>
