<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>대시보드</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4364f7; --light-gray: #f8f9fa; --medium-gray: #e9ecef; --dark-gray: #495057; --card-bg: #fff; --box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05); --border-radius: 10px; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--light-gray); margin: 0; padding: 20px; max-width: 1200px; margin: auto; }
        h2 { color: var(--primary); margin-bottom: 20px; }
        .card { background: var(--card-bg); box-shadow: var(--box-shadow); border-radius: var(--border-radius); margin-bottom: 25px; padding: 20px; }
        .card h3 { margin-top: 0; color: var(--dark-gray); border-bottom: 1px solid var(--medium-gray); padding-bottom: 10px; margin-bottom: 10px; font-size: 1.1em; }
        ul { list-style: none; padding-left: 0; margin: 0; }
        li { padding: 12px 5px; border-bottom: 1px solid var(--medium-gray); display: flex; align-items: center; gap: 15px; border-radius: 5px; }
        li:last-child { border-bottom: none; }
        .date { font-weight: 600; color: var(--primary); width: 150px; text-align: center; }
        .desc { color: #555; }
        .placeholder { color: #999; text-align: center; padding: 20px; }

        /* ✅ [추가] 깜빡이는 애니메이션 효과 */
        .blinking {
            animation: blink-effect 1.5s infinite;
        }
        @keyframes blink-effect {
            50% {
                background-color: #fffbe6; /* 밝은 노란색 배경 */
                box-shadow: 0 0 10px #ffecb3;
            }
        }
    </style>
</head>
<body>

    <h2>대시보드</h2>

        <div class="card">
        <h3>우리 지점 실기일정 (가까운 순)</h3>
        <ul id="schedule-list">
            <li class="placeholder">일정을 불러오는 중입니다...</li>
        </ul>
    </div>
    <div class="card">
        <h3>합격자 발표 일정 (가까운 순)</h3>
        <ul id="announcement-list">
            <li class="placeholder">일정을 불러오는 중입니다...</li>
        </ul>
    </div>
    


<script>
    const SERVER = 'https://supermax.kr';
    const token = window.parent.localStorage.getItem('token');

    // ✅ [추가] 날짜가 이번 주에 속하는지 확인하는 함수
    function isDateInCurrentWeek(dateString) {
        if (!dateString) return false;
        
        const formattedString = dateString.split(' ')[0].replace(/\./g, '-');
        const targetDate = new Date(formattedString + 'T00:00:00');
        if (isNaN(targetDate.getTime())) return false;

        const today = new Date();
        today.setHours(0, 0, 0, 0); // 시간 정보 초기화

        // 이번 주의 월요일과 일요일 계산
        const dayOfWeek = today.getDay(); // 0(일) ~ 6(토)
        const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // 일요일이면 6일 빼고, 아니면 (1 - 요일)
        const monday = new Date(today);
        monday.setDate(today.getDate() + diffToMonday);

        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);

        return targetDate >= monday && targetDate <= sunday;
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const formattedString = dateString.split(' ')[0].replace(/\./g, '-');
        const date = new Date(formattedString + 'T00:00:00');
        if (isNaN(date.getTime())) return dateString;
        const days = ['일', '월', '화', '수', '목', '금', '토'];
        return `${date.getMonth() + 1}월 ${date.getDate()}일 (${days[date.getDay()]})`;
    }

    async function loadAnnouncementDates() {
        const list = document.getElementById('announcement-list');
        if (!token) { list.innerHTML = `<li class="placeholder">로그인 정보가 필요합니다.</li>`; return; }

        try {
            const res = await fetch(`${SERVER}/26susi/announcement-dates`, { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();

            if (data.success && data.dates.length > 0) {
                list.innerHTML = '';
                data.dates.forEach(item => {
                    const li = document.createElement('li');
                    // ✅ [수정] 이번 주 일정에 깜빡임 효과 클래스 추가
                    if (isDateInCurrentWeek(item.발표일)) {
                        li.classList.add('blinking');
                    }
                    li.innerHTML = `
                        <div class="date">${formatDate(item.발표일)}</div>
                        <div class="desc">${item.대학명} ${item.학과명} - ${item.내용}</div>
                    `;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = `<li class="placeholder">예정된 발표 일정이 없습니다.</li>`;
            }
        } catch (error) {
            console.error("발표일정 로딩 실패:", error);
            list.innerHTML = `<li class="placeholder">일정을 불러오는 데 실패했습니다.</li>`;
        }
    }

    async function loadBranchSchedule() {
        const list = document.getElementById('schedule-list');
        if (!token) { list.innerHTML = `<li class="placeholder">로그인 정보가 필요합니다.</li>`; return; }
        
        try {
            const res = await fetch(`${SERVER}/26susi/branch-schedule`, { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();

            if (data.success && data.schedule.length > 0) {
                list.innerHTML = '';
                data.schedule.forEach(item => {
                    const li = document.createElement('li');
                    const studentNames = item.students.join(', ');
                    // ✅ [수정] 이번 주 일정에 깜빡임 효과 클래스 추가
                    if (isDateInCurrentWeek(item.date)) {
                        li.classList.add('blinking');
                    }
                    li.innerHTML = `
                        <div class="date">${formatDate(item.date)}</div>
                        <div class="desc">${item.university} ${item.department} - <strong>${studentNames}</strong> 학생</div>
                    `;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = `<li class="placeholder">예정된 실기 일정이 없습니다.</li>`;
            }
        } catch (error) {
            console.error("실기일정 로딩 실패:", error);
            list.innerHTML = `<li class="placeholder">일정을 불러오는 데 실패했습니다.</li>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadAnnouncementDates();
        loadBranchSchedule();
    });
</script>
</body>
</html>
