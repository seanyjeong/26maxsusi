<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ëŒ€í•™ë³„ ë‚´ì‹ /ë“±ê¸‰ ì…ë ¥ ì‹œìŠ¤í…œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #e6e9ff;
      --border: #e0e0e0;
      --header-bg: #f8f9fa;
    }
    
    body {
      font-family: 'Noto Sans KR', sans-serif;
      max-width: 98%;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    
    h2 {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      padding-bottom: 10px;
      margin-bottom: 20px;
      font-weight: 700;
    }
    
    #branchInfo {
      background: var(--primary-light);
      padding: 8px 12px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    #searchInput {
      width: 300px;
      padding: 10px 15px;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    #searchInput:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    th, td {
      padding: 12px 8px;
      text-align: center;
      border: 1px solid var(--border);
    }
    
    thead th {
      background-color: var(--header-bg);
      font-weight: 600;
      position: sticky;
      z-index: 1;
    }
    
    tbody tr:hover {
      background-color: rgba(67, 97, 238, 0.03);
    }
    
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 4px;
      font-size: 0.85em;
      text-align: center;
      border: 1px solid var(--border);
      border-radius: 3px;
    }
    
    input[type="text"]:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
    }
    
    .col-name {
      white-space: nowrap;
      font-weight: 600;
      color: var(--primary);
      min-width: 160px;
    }
    
    .row-no {
      color: #999;
      font-weight: 500;
    }
    
    #msg {
      background-color: #e8f5e9;
      color: #2e7d32;
      padding: 10px 15px;
      border-radius: 4px;
      margin-top: 15px;
      display: inline-block;
      font-weight: 500;
    }
    
    .controls {
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    ::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    thead tr:first-child th {
      top: 0;
      z-index: 2;
    }

    thead tr:nth-child(2) th {
      top: 45px;
      border-bottom: 1px solid var(--border);
    }
  </style>
</head>
<body>
  <div class="controls">
    <h2>ëŒ€í•™ë³„ ë‚´ì‹ /ë“±ê¸‰ ì…ë ¥ ì‹œìŠ¤í…œ</h2>
  </div>
  
  <div id="branchInfo"></div>

  <div>
    <input type="text" id="searchInput" placeholder="ëŒ€í•™ëª…, í•™ê³¼ëª…, ì „í˜•ëª…ìœ¼ë¡œ ê²€ìƒ‰">
  </div>
  
<div id="pagination-controls" style="margin: 20px 0; display: flex; align-items: center; gap: 15px;">
Â  Â  <button id="prevPageBtn">&laquo; ì´ì „ í•™ìƒë“¤</button>
Â  Â  <span id="pageInfo"></span>
Â  Â  <button id="nextPageBtn">ë‹¤ìŒ í•™ìƒë“¤ &raquo;</button>

    <div style="margin-left: auto; display: flex; align-items: center; gap: 5px;">
        <input type="text" id="studentSearchInput" placeholder="í•™ìƒ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰" style="width: 150px; padding: 8px; font-size: 14px;">
        <button id="studentSearchBtn">ê²€ìƒ‰</button>
    </div>
    Â  </div>

  <div style="overflow-x:auto; max-height: 70vh; border: 1px solid #eee; border-radius: 6px;">
    <table id="gradeTable">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  
  <div id="msg"></div>
  
  <script>
    const SERVER = 'https://supermax.kr';
    let branch = '';
    let token = localStorage.getItem('token');
    if (!token) location.href = 'login.html?next=' + encodeURIComponent(location.pathname);

    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch { return {}; }
    }
    const payload = parseJwt(token);
    branch = payload.branch;
    document.getElementById('branchInfo').textContent = "ë‚´ ì§€ì : " + (branch || '(ì§€ì ì •ë³´ì—†ìŒ)');

    let colleges = [], students = [], grade_map = {};
    let filteredColleges = [];

    let currentPage = 1;
    const studentsPerPage = 5;

    async function loadAll() {
      const res = await fetch(SERVER + '/26susi_student_grade_map', {
        headers: { Authorization: 'Bearer ' + token }
      });
      const json = await res.json();
      if (!json.success) {
        document.getElementById('msg').textContent = "ë°ì´í„° ë¡œë”© ì˜¤ë¥˜! ë‹¤ì‹œ ë¡œê·¸ì¸ í•„ìš”";
        if(json.message && json.message.includes("ê¶Œí•œì—†ìŒ")) logout();
        return;
      }
   colleges = json.colleges;
   // âœ… ëŒ€í•™ëª…ì„ ê°€ë‚˜ë‹¤ìˆœìœ¼ë¡œ ì •ë ¬í•˜ëŠ” ì½”ë“œ ì¶”ê°€
   colleges.sort((a, b) => a.ëŒ€í•™ëª….localeCompare(b.ëŒ€í•™ëª…));
   
   students = json.students;
   grade_map = json.grade_map;
      filteredColleges = colleges;
      
      renderTable();
      setupPagination();
      setupStudentSearch();
    }

    document.getElementById('searchInput').addEventListener('input', function() {
      const q = this.value.trim().toLowerCase();
      // ê²€ìƒ‰ ì‹œì—ëŠ” currentPageë¥¼ 1ë¡œ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ. ëŒ€í•™ í•„í„°ë§ì€ í•™ìƒ í˜ì´ì§€ì™€ ë¬´ê´€.
      filteredColleges = colleges.filter(col =>
        (col.ëŒ€í•™ëª… && col.ëŒ€í•™ëª….toLowerCase().includes(q)) ||
        (col.í•™ê³¼ëª… && col.í•™ê³¼ëª….toLowerCase().includes(q)) ||
        (col.ì „í˜•ëª… && col.ì „í˜•ëª….toLowerCase().includes(q))
      );
      renderTable();
    });

    // ğŸ‘‡ ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ì–´ì¤˜
function setupStudentSearch() {
    const searchInput = document.getElementById('studentSearchInput');
    const searchBtn = document.getElementById('studentSearchBtn');

    const findStudent = () => {
        const query = searchInput.value.trim().toLowerCase();
        if (!query) {
            alert("ê²€ìƒ‰í•  í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        // ì „ì²´ í•™ìƒ ëª©ë¡(students)ì—ì„œ ì´ë¦„ì´ í¬í•¨ëœ í•™ìƒì˜ ìˆœì„œ(index)ë¥¼ ì°¾ìŒ
        const studentIndex = students.findIndex(st => 
            st.ì´ë¦„ && st.ì´ë¦„.toLowerCase().includes(query)
        );

        if (studentIndex !== -1) {
            // í•™ìƒì„ ì°¾ì•˜ì„ ê²½ìš°
            // í•™ìƒì˜ ìˆœì„œë¥¼ ì´ìš©í•´ ëª‡ í˜ì´ì§€ì— ìˆëŠ”ì§€ ê³„ì‚°
            const targetPage = Math.floor(studentIndex / studentsPerPage) + 1;
            if (currentPage !== targetPage) {
                currentPage = targetPage;
                renderTable(); // í•´ë‹¹ í˜ì´ì§€ë¡œ í…Œì´ë¸”ì„ ë‹¤ì‹œ ê·¸ë¦¼
            }
        } else {
            // í•™ìƒì„ ëª» ì°¾ì•˜ì„ ê²½ìš°
            alert('"' + searchInput.value + '" í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    };

    searchBtn.addEventListener('click', findStudent);
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            findStudent();
        }
    });
}

    function renderTable() {
      const startIndex = (currentPage - 1) * studentsPerPage;
      const endIndex = startIndex + studentsPerPage;
      const paginatedStudents = students.slice(startIndex, endIndex);

      let headHtml = `<tr>
        <th rowspan="2">No</th>
        <th rowspan="2">ëŒ€í•™ëª…</th>
        <th rowspan="2">í•™ê³¼ëª…</th>
        <th rowspan="2">ì „í˜•ëª…</th>`;
      paginatedStudents.forEach(st => {
        headHtml += `<th colspan="2" class="col-name">${st.ì´ë¦„}</th>`;
      });
      headHtml += `</tr><tr>`;
      paginatedStudents.forEach(() => {
        headHtml += `<th>ë“±ê¸‰</th><th>ë‚´ì‹ </th>`;
      });
      headHtml += `</tr>`;
      document.getElementById('tableHead').innerHTML = headHtml;

      let bodyHtml = '';
      (filteredColleges || []).forEach((col, rowIdx) => {
        bodyHtml += `<tr>
          <td class="row-no">${rowIdx + 1}</td>
          <td>${col.ëŒ€í•™ëª…}</td>
          <td>${col.í•™ê³¼ëª… || ''}</td>
          <td>${col.ì „í˜•ëª… || ''}</td>`;

        paginatedStudents.forEach(st => {
          const key = `${st.í•™ìƒID}-${col.ëŒ€í•™ID}`;
          const grade = grade_map[key]?.ë“±ê¸‰ || '';
          const score = grade_map[key]?.ë‚´ì‹ ì ìˆ˜ || '';
          bodyHtml += `
            <td><input type="text" value="${grade}" 
              onchange="updateGrade(${st.í•™ìƒID},'${col.ëŒ€í•™ID}', this.value, null)" 
              placeholder="ë“±ê¸‰"></td>
            <td><input type="text" value="${score}"
              onchange="updateGrade(${st.í•™ìƒID},'${col.ëŒ€í•™ID}', null, this.value)" 
              placeholder="ë‚´ì‹ "></td>`;
        });

        bodyHtml += `</tr>`;
      });
      document.getElementById('tableBody').innerHTML = bodyHtml;
      
      updatePageInfo();
    }
    
    function updatePageInfo() {
      const totalPages = Math.ceil(students.length / studentsPerPage);
      document.getElementById('pageInfo').textContent = `í˜ì´ì§€ ${currentPage} / ${totalPages > 0 ? totalPages : 1}`;
      document.getElementById('prevPageBtn').disabled = (currentPage === 1);
      document.getElementById('nextPageBtn').disabled = (currentPage >= totalPages);
    }

    function setupPagination() {
      document.getElementById('prevPageBtn').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      });

      document.getElementById('nextPageBtn').addEventListener('click', () => {
        const totalPages = Math.ceil(students.length / studentsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      });
    }

    async function updateGrade(student_id, college_id, grade, score) {
      const key = `${student_id}-${college_id}`;
      const prev = grade_map[key] || {};
      if (grade === null) grade = prev.ë“±ê¸‰ || '';
      if (score === null) score = prev.ë‚´ì‹ ì ìˆ˜ || '';
      grade_map[key] = { ë“±ê¸‰: grade, ë‚´ì‹ ì ìˆ˜: score };

      const res = await fetch(SERVER + '/26susi_student_grade_update', {
        method:'POST',
        headers:{
          'Authorization':'Bearer '+token,
          'Content-Type':'application/json'
        },
        body: JSON.stringify({
          student_id, college_id,
          "ë“±ê¸‰": grade, "ë‚´ì‹ ì ìˆ˜": score
        })
      });
      const json = await res.json();
      if(!json.success) {
        document.getElementById('msg').textContent = json.message||'ì €ì¥ì‹¤íŒ¨';
        document.getElementById('msg').style.backgroundColor = '#ffebee';
        document.getElementById('msg').style.color = '#c62828';
      } else {
        document.getElementById('msg').textContent = "ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!";
        document.getElementById('msg').style.backgroundColor = '#e8f5e9';
        document.getElementById('msg').style.color = '#2e7d32';
        setTimeout(()=>{ 
          document.getElementById('msg').textContent = ""; 
          document.getElementById('msg').style.backgroundColor = '';
        }, 1500);
      }
    }

    function logout() {
      localStorage.removeItem('token');
      location.href = 'login.html?next=' + encodeURIComponent(location.pathname);
    }

    loadAll();
  </script>
</body>
</html>

