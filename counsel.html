<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>상담 입력</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

 
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --primary-color: #4364f7;
      --secondary-color: #6a8eff;
      --accent-color: #3a86ff;
      --light-gray: #f8f9fa;
      --medium-gray: #e9ecef;
      --dark-gray: #495057;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --border-radius: 6px;
      --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    .section.compact {
  padding: 10px 15px;
}

.section {
  background-color: white;
  border-radius: var(--border-radius);
  padding: 20px;
  margin-bottom: 12px;
  box-shadow: var(--box-shadow);
  width: 100%; /* 현재 100%이므로 중앙 정렬이 안 됨 */
  max-width: 1200px; /* ⬅️ 이 값을 추가하여 div.section의 최대 너비를 제한합니다. */
  margin: 0 auto; /* ⬅️ 이 값을 추가하여 div.section 자체를 중앙 정렬합니다. */
  overflow-x: hidden; /* 또는 auto, 필요에 따라 */
}


    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f7fa;
      padding: 20px;
      max-width: 1300px;
      margin: 0 auto;
    }

    h2 {
      color: var(--primary-color);
      margin-bottom: 25px;
      font-weight: 700;
      font-size: 1.8rem;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 10px;
    }

table {
  width: 100%; /* ⬅️ 부모 section의 100% 너비를 차지하도록 유지 */
  max-width: 1200px; /* ⬅️ 테이블의 최대 너비는 section의 최대 너비와 같거나 작게 */
  margin-left: auto; /* ⬅️ 부모 section 내에서 중앙 정렬 */
  margin-right: auto; /* ⬅️ 부모 section 내에서 중앙 정렬 */
  border-collapse: collapse;
  margin-bottom: 25px;
  background-color: white;
  border-radius: var(--border-radius);
  overflow: hidden;
  box-shadow: var(--box-shadow);
  /* ⬅️ 가장 중요: 테이블 레이아웃을 고정하여 각 열의 너비를 강제합니다. */
  table-layout: fixed;
}

/* 각 th/td에 명확한 너비 설정 (이 비율을 이미지에 맞게 미세 조정하세요) */
/* 모든 열의 width 합계가 100%가 되도록 조정하는 것이 중요합니다. */
/* [수정 후] : 비율을 조정하여 총 100%가 되도록 합니다. */
.college-group-header th:nth-child(1), td:nth-child(1) { width: 15%; } /* 대학명 */
.college-group-header th:nth-child(2), td:nth-child(2) { width: 15%; } /* 학과명 */
.college-group-header th:nth-child(3), td:nth-child(3) { width: 12%; } /* 전형명 */
.college-group-header th:nth-child(4), td:nth-child(4) { width: 6%; }  /* 등급 */
.college-group-header th:nth-child(5), td:nth-child(5) { width: 8%; }  /* 내신점수 */
.college-group-header th:nth-child(6), td:nth-child(6) { width: 8%; }  /* 실기총점 */
.college-group-header th:nth-child(7), td:nth-child(7) { width: 8%; }  /* 합산점수 */
.college-group-header th:nth-child(8), td:nth-child(8) { width: 9%; }  /* 맥스예상컷 */
.college-group-header th:nth-child(9), td:nth-child(9) { width: 9%; }  /* 지점예상컷 */
.college-group-header th:last-child, td:last-child { width: 4%; }  /* 삭제 */

/* 셀 내부의 텍스트와 input 요소들도 중앙 정렬 */
th, td {
  padding: 8px;
  text-align: center; /* ⬅️ 셀 내용을 중앙 정렬 */
  border: 1px solid var(--medium-gray);
  white-space: nowrap; /* 셀 내용이 길어질 때 줄바꿈 방지 */
}

/* select 요소는 텍스트는 좌측 정렬하되, 전체 너비는 셀에 맞춤 */
td select {
    min-width: unset; /* 전역 min-width 해제 */
    width: 100%; /* ⬅️ 셀 너비에 맞게 100%로 설정 */
    text-align: left; /* 텍스트는 왼쪽 정렬 */
    /* ... 기타 select 스타일 ... */
}

/* input 요소는 텍스트를 중앙 정렬 */
.input-sm, .input-grade, .input-score, .input-total-score, .합산점수 {
    text-align: center; /* ⬅️ input 내부 텍스트 중앙 정렬 */
}

    .row-wrap {
      display: flex;
      gap: 20px;
      align-items: flex-end;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark-gray);
    }

    select, input, textarea {
      font-family: 'Noto Sans KR', sans-serif;
      padding: 10px 12px;
      border: 1px solid var(--medium-gray);
      border-radius: var(--border-radius);
      font-size: 14px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(67, 100, 247, 0.2);
    }

    select {
      background-color: white;
      min-width: 180px;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: var(--secondary-color);
    }

    .add-row-btn {
      background-color: var(--success-color);
      margin-left: 10px;
    }

    .add-row-btn:hover {
      background-color: #218838;
    }

    .del-btn {
      background-color: var(--danger-color);
      padding: 6px 10px;
      font-size: 13px;
    }

    .del-btn:hover {
      background-color: #c82333;
    }
table {
  width: 100%;
  max-width: 1200px; /* 표의 최대 너비 설정 */
  margin-left: auto; /* ⬅️ 이 줄을 유지하여 표를 중앙에 정렬합니다. */
  margin-right: auto; /* ⬅️ 이 줄을 유지하여 표를 중앙에 정렬합니다. */
  
  border-collapse: collapse;
  margin-bottom: 25px;
  background-color: white;
  border-radius: var(--border-radius);
  overflow: hidden;
  box-shadow: var(--box-shadow);
}



    th, td {
      padding: 8px;
      text-align: center;
      border: 1px solid var(--medium-gray);
      white-space: nowrap;
    }

    .college-group-header th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      font-size: 13px;
      padding: 10px 8px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr:nth-child(even) {
      background-color: var(--light-gray);
    }

    tr:hover {
      background-color: rgba(67, 100, 247, 0.05);
    }

    .input-sm {
      width: 70px;
      padding: 8px;
      text-align: center;
      font-size: 13px;
    }

    .input-grade {
      width: 60px;
    }

    .input-score {
      width: 80px;
    }

    .input-memo {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border-radius: var(--border-radius);
      resize: vertical;
    }

    .practical-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      padding: 10px 0;
      justify-content: left;
    }

    .practical-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 120px;
      border: 1px solid var(--medium-gray);
      border-radius: var(--border-radius);
      padding: 8px 5px;
      background-color: var(--light-gray);
    }

    .practical-input-container {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }

    .practical-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--dark-gray);
      white-space: nowrap;
      text-align: center;
      margin-bottom: 5px;
    }

    .input-sm[readonly] {
      background-color: var(--medium-gray);
      border-color: #ddd;
      color: #666;
    }
    
    

    #msg {
      margin-left: 15px;
      color: var(--success-color);
      font-weight: 500;
    }

    /* 반응형 디자인 */
    @media (max-width: 1600px) {
      body {
        padding: 15px;
      }
    }

    @media (max-width: 1200px) {
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      th, td {
        white-space: normal;
      }

      .practical-row {
        justify-content: flex-start;
      }
    }

    @media (max-width: 768px) {
      .row-wrap {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      select, input {
        width: 100%;
      }
    }

    .score-table-btn {
    font-size: 11px;
    padding: 3px 6px;
    margin-left: 8px;
    background-color: var(--secondary-color);
}

    /* ✅ 2. 팝업(모달) 스타일 추가 */
.modal {
    display: none; 
    position: fixed; 
    z-index: 100; 
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto; 
    background-color: rgba(0,0,0,0.6);
}
.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 1200px;
    border-radius: var(--border-radius);
    position: relative;
}
.close-btn {
    color: #aaa;
    position: absolute;
    top: 10px;
    right: 20px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}
.close-btn:hover { color: black; }
#modalTitle { margin-bottom: 20px; color: var(--primary-color); }
#modalTableContainer { display: flex; gap: 16px; overflow-x: auto; }
#modalTableContainer table { min-width: 300px; }

/* ✅ PDF 출력 모드 설정 */
/* PDF 출력 모드에서 테이블과 셀 너비 조정 */
/* PDF 출력 모드 설정 (수정됨) */
.pdf-export-mode {
    /* 캡처 영역 자체의 너비를 고정하는 것이 더 안정적일 수 있음 */
    width: 1200px !important;
    margin: 0 auto;
}

.pdf-export-mode table {
    width: 100% !important;
    table-layout: fixed !important; /* auto 대신 fixed로 유지 */
    /* margin-left와 margin-right를 제거하여 부모 요소의 중앙 정렬을 따름 */
}

.pdf-export-mode th, 
.pdf-export-mode td {
padding: 4px !important;
font-size: 10px !important;
word-break: keep-all !important;
white-space: normal !important;
  /* min-width는 그대로 두거나 필요 시 조정 */
}
/* 이하 다른 pdf-export-mode 스타일은 그대로 유지 */

.pdf-export-mode th, 
.pdf-export-mode td {
  padding: 4px !important;
  font-size: 10px !important;
  min-width: 50px !important; /* 최소 너비 보장 */
  word-break: keep-all !important; /* 단어 잘림 방지 */
  white-space: normal !important; /* 줄바꿈 허용 */
}

/* 왼쪽 정렬이 필요한 셀에 대해 */
.pdf-export-mode td:nth-child(1),
.pdf-export-mode th:nth-child(1) {
  text-align: left !important;
  padding-left: 2px !important;
}



/* PDF 생성 시 임시 제목 스타일 */
#pdf-temp-title {
    text-align: center;
    color: #4364f7; /* 메인 테마 색상 */
    margin-bottom: 25px;
    font-size: 24px;
    font-weight: 700;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 15px;
}

/* PDF 출력 시 입력창 잘림 현상 해결을 위한 최종 코드 */
.pdf-export-mode .input-sm {
    height: 42px !important; /* 캡처 시 높이를 강제로 늘려 잘릴 공간을 원천 차단 */
    margin-bottom: 2px;      /* 확실한 공간 확보를 위해 아래 외부 여백도 살짝 추가 */
}



/* PDF 생성 로딩 스피너 스타일 */
.swal2-spinner {
  display: inline-block;
  width: 50px;
  height: 50px;
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left-color: #4364f7; /* 메인 테마 색상 */
  border-radius: 50%;
  animation: swal2-rotate-spinner 1s linear infinite;
  margin: 20px auto;
}

@keyframes swal2-rotate-spinner {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
  
  </style>
</head>
<body>

<h2 id="main-title"></h2>
  

<div class="section compact">
  <div class="row-wrap">
    <div style="flex-grow: 1;">
      <label>학생 선택</label>
      <select id="studentSelect" style="width: 100%;"></select>
    </div>
    <div>
  <button type="button" class="add-row-btn" onclick="addCollegeRow()">+ 대학 추가</button>
  <button type="submit" form="counselForm" style="margin-left: 10px;">상담내용 저장</button>
  <button type="button" onclick="downloadPDF()" style="background-color: #28a745; margin-left: 10px;">PDF로 저장</button>
</div>
  </div>
</div>


  
  <div id="captureArea">
    <form id="counselForm" autocomplete="off">
      <div class="section" style="overflow-x: auto;">
        <table id="collegeTable">
          <tbody id="collegeTbody"></tbody>
        </table>
      </div>
      
      <div class="section">
        <label>상담 메모</label>
        <textarea id="counselMemo" class="input-memo" placeholder="상담 내용을 상세히 입력해주세요"></textarea>
      </div>
    </form>
    
    <div style="display: flex; align-items: center; margin-top: 20px;">
      <button type="submit" form="counselForm">상담내용 저장</button>
      <span id="msg" style="margin-left: 15px;"></span>
    </div>
  </div>

<div id="scoreTableModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeScoreTablePopup()">&times;</span>
        <h3 id="modalTitle"></h3>
        <div id="modalTableContainer"></div>
    </div>
</div>

  <script>
const SERVER = 'https://supermax.kr';
let token = localStorage.getItem('token');
if (!token) location.href = 'login.html';

let students = [], colleges = [], studentMap = {}, collegeGroups = {};

// [counsel.html] 이 함수로 교체
async function updateAllScores(tbody) {
    const student = studentMap[document.getElementById('studentSelect').value];
    const collegeID = getCollegeIDByTbody(tbody);
    if (!student || !collegeID) return;

    const 내신점수 = tbody.querySelector('.input-score').value || 0;
    const practicalGroups = tbody.querySelectorAll('.practical-group');
    const inputs = Array.from(practicalGroups).map(group => ({
        종목명: group.querySelector('.practical-label').textContent.split('(')[0].trim(),
        기록: group.querySelector('.input-record').value.trim() || null
    }));

    const res = await fetch(`${SERVER}/26susi/calculate-final-score`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ 대학ID: collegeID, gender: student.성별, inputs, 내신점수 })
    });
    const data = await res.json();
    
    if (data.success) {
        // 개별 점수 및 감수 표시
        practicalGroups.forEach(group => {
            const label = group.querySelector('.practical-label');
            let eventName = label.textContent.split('(')[0].trim();
            const score = data.종목별점수[eventName];
            const gam = data.종목별감수[eventName];

            group.querySelector('.input-score-only').value = score;
            
            // 기존 감수 span 제거 후 새로 추가
            label.querySelectorAll('.gam-span').forEach(span => span.remove());
            if (gam > 0) {
                const gamSpan = document.createElement('span');
                gamSpan.className = 'gam-span';
                gamSpan.style.color = 'red';
                gamSpan.style.marginLeft = '5px';
                gamSpan.textContent = `(${gam}감)`;
                label.appendChild(gamSpan);
            }
        });

        // 최종 점수 및 총 감수 표시
        const totalScoreCell = tbody.querySelector('.input-total-score').parentElement;
        totalScoreCell.querySelectorAll('.total-gam-span').forEach(span => span.remove()); // 기존 총감수 span 제거
        tbody.querySelector('.input-total-score').value = data.실기총점;
        if (data.총감수 > 0) {
            const totalGamSpan = document.createElement('span');
            totalGamSpan.className = 'total-gam-span';
            totalGamSpan.style.color = 'red';
            totalGamSpan.style.fontWeight = 'bold';
            totalGamSpan.style.marginLeft = '5px';
            totalGamSpan.textContent = `(총 ${data.총감수}감)`;
            totalScoreCell.appendChild(totalGamSpan);
        }
        tbody.querySelector('.합산점수').value = data.합산점수;
    }
}
    
async function loadData() {
    Swal.fire({
        title: '데이터 로딩중...',
        html: `<img src="https://github.com/seanyjeong/supermax/blob/main/maxmax.png?raw=true" alt="로딩 로고" style="width: 120px; margin-bottom: 20px;"><div class="swal2-spinner"></div>`,
        allowOutsideClick: false, showConfirmButton: false,
    });
    try {
        const [profileRes, studentRes, collegeRes] = await Promise.all([
            fetch(SERVER + '/26susi/profile', { headers: { Authorization: 'Bearer ' + token } }),
            fetch(SERVER + '/26susi_student_list', { headers: { Authorization: 'Bearer ' + token } }),
            fetch(SERVER + '/26susi_college_list', { headers: { Authorization: 'Bearer ' + token } }),
        ]);
        const profileData = await profileRes.json();
        if (profileData.success && profileData.user.branch) {
            document.getElementById('main-title').textContent = `2026맥스체대입시 ${profileData.user.branch} 교육원 수시상담`;
        } else { document.getElementById('main-title').textContent = "26맥스체대입시 수시상담"; }
        students = (await studentRes.json()).students || [];
        studentMap = {}; students.forEach(s => { studentMap[s.학생ID] = s; });
        colleges = (await collegeRes.json()).colleges || [];
        groupColleges(); renderStudentSelect(); addCollegeRow();
    } catch (error) {
        console.error("초기 데이터 로딩 실패:", error);
        Swal.fire({ icon: 'error', title: '오류', text: '데이터를 불러오는 데 실패했습니다.' });
    } finally { Swal.close(); }
}

function groupColleges() {
    collegeGroups = {};
    colleges.forEach(c => {
        if (!collegeGroups[c.대학명]) collegeGroups[c.대학명] = {};
        if (!collegeGroups[c.대학명][c.학과명]) collegeGroups[c.대학명][c.학과명] = [];
        if (!collegeGroups[c.대학명][c.학과명].includes(c.전형명)) collegeGroups[c.대학명][c.학과명].push(c.전형명);
    });
}

function renderStudentSelect() {
    const sel = document.getElementById('studentSelect');
    sel.innerHTML = '<option value="" selected disabled>학생을 선택하세요.</option>' + students.map(s => `<option value="${s.학생ID}">${s.이름} (${s.성별})</option>`).join('');
}

function reNumberRows() {
    document.querySelectorAll('#collegeTbody .row-counter').forEach((counter, i) => { counter.textContent = `${i + 1}.`; });
}

function addCollegeRow() {
    const tbody = document.getElementById('collegeTbody');
    const idx = tbody.querySelectorAll('.row-group').length + 1;
    const group = document.createElement('tbody');
    group.classList.add('row-group');
    const collegeGroupHeader = document.createElement('tr');
    collegeGroupHeader.classList.add('college-group-header');
    collegeGroupHeader.innerHTML = `<th><span class="row-counter">${idx}.</span> 대학명<button type="button" class="score-table-btn" onclick="openScoreTablePopup(this)">배점표</button></th><th>학과명</th><th>전형명</th><th>등급</th><th>내신점수</th><th>실기총점</th><th>합산점수</th><th>26맥스컷</th><th>26지점컷</th><th></th>`;
    group.appendChild(collegeGroupHeader);
    const infoRow = document.createElement('tr');
    infoRow.innerHTML = `<td><select class="sel-college" onchange="onCollegeNameChange(this)"></select></td><td><select class="sel-major" onchange="onMajorChange(this)" disabled></select></td><td><select class="sel-type" onchange="onTypeChange(this)" disabled></select></td><td><input type="text" class="input-grade" onchange="onInputEdit(this)"></td><td><input type="text" class="input-score" onchange="onInputEdit(this)"></td><td><input type="text" class="input-total-score" readonly></td><td><input type="text" class="input-score 합산점수" readonly></td><td><input type="text" class="input-score max-cut" readonly></td><td><input type="text" class="input-score branch-cut" readonly></td><td><button class="del-btn" onclick="this.closest('tbody').remove(); reNumberRows();">삭제</button></td>`;
    group.appendChild(infoRow);
    const practicalRow = document.createElement('tr');
    practicalRow.innerHTML = `<td colspan="10"><div class="practical-row practical-fields"></div></td>`;
    group.appendChild(practicalRow);
    tbody.appendChild(group);
    reNumberRows();
    group.querySelector('.sel-college').innerHTML = '<option value="">선택</option>' + Object.keys(collegeGroups).map(c => `<option value="${c}">${c}</option>`).join('');
}

function onCollegeNameChange(sel) {
    const tbody = sel.closest('tbody'), majorSel = tbody.querySelector('.sel-major'), typeSel = tbody.querySelector('.sel-type');
    majorSel.innerHTML = '<option value="">선택</option>'; majorSel.disabled = true;
    typeSel.innerHTML = '<option value="">선택</option>'; typeSel.disabled = true;
    tbody.querySelector('.practical-fields').innerHTML = '';
    tbody.querySelector('.input-total-score').value = ''; tbody.querySelector('.합산점수').value = '';
    if (sel.value) {
        majorSel.innerHTML += Object.keys(collegeGroups[sel.value] || {}).map(m => `<option value="${m}">${m}</option>`).join('');
        majorSel.disabled = false;
    }
}

function onMajorChange(sel) {
    const tbody = sel.closest('tbody'), collegeSel = tbody.querySelector('.sel-college'), typeSel = tbody.querySelector('.sel-type');
    typeSel.innerHTML = '<option value="">선택</option>'; typeSel.disabled = true;
    tbody.querySelector('.practical-fields').innerHTML = '';
    tbody.querySelector('.input-total-score').value = ''; tbody.querySelector('.합산점수').value = '';
    if (collegeSel.value && sel.value) {
        (collegeGroups[collegeSel.value][sel.value] || []).forEach(t => typeSel.innerHTML += `<option value="${t}">${t}</option>`);
        typeSel.disabled = false;
    }
}

async function onTypeChange(sel) {
    const tbody = sel.closest('tbody.row-group');
    const collegeSel = tbody.querySelector('.sel-college');
    const majorSel = tbody.querySelector('.sel-major');
    const practicalContainer = tbody.querySelector('.practical-fields');
    if (!collegeSel.value || !majorSel.value || !sel.value) { practicalContainer.innerHTML = ''; return; }
    const collegeID = getCollegeID(collegeSel.value, majorSel.value, sel.value);
    const matched = colleges.find(c => c.대학ID === collegeID);
    tbody.querySelector('.max-cut').value = matched?.['26맥스예상컷'] || '';
    tbody.querySelector('.branch-cut').value = matched?.['지점예상컷'] || '';
    const practical_id = matched?.실기ID;
    const student_id = document.getElementById('studentSelect').value;
    const student = studentMap[student_id];
    if (!student) { practicalContainer.innerHTML = '<span style="color:red;">학생을 먼저 선택하세요.</span>'; return; }
    if (!practical_id) { practicalContainer.innerHTML = '<span style="color:gray;">실기 종목이 없습니다.</span>'; }
    else {
        const res = await fetch(`${SERVER}/26susi_events_by_practical_id?practical_id=${practical_id}&gender=${student.성별}`, { headers: { Authorization: 'Bearer ' + token } });
        const json = await res.json();
        const events = [...new Set((json.events || []).map(e => e.종목명))];
        practicalContainer.innerHTML = events.map(e => `<div class="practical-group"><span class="practical-label">${e}</span><div class="practical-input-container"><input type="text" class="input-sm input-record" placeholder="기록" oninput="onRecordInputChange(this)"><input type="text" class="input-sm input-score-only" placeholder="점수" readonly></div></div>`).join('');
    }
    if (collegeID && student_id) {
        const res2 = await fetch(`${SERVER}/26susi_student_grade?student_id=${student_id}`, { headers: { Authorization: 'Bearer ' + token } });
        const json2 = await res2.json();
        if (json2.success && Array.isArray(json2.grades)) {
            const g = json2.grades.find(row => row.대학ID === collegeID);
            if (g) { tbody.querySelector('.input-grade').value = g.등급 ?? ''; tbody.querySelector('.input-score').value = g.내신점수 ?? ''; }
        }
    }
    await updateAllScores(tbody);
}

function onRecordInputChange(input) {
    updateAllScores(input.closest('tbody.row-group'));
}

// ✅✅✅ 중복된 함수 중 올바른 버전 하나만 남김 ✅✅✅
function onInputEdit(input) {
    const tbody = input.closest('tbody');
    const student_id = document.getElementById('studentSelect').value;
    const collegeID = getCollegeIDByTbody(tbody);
    if (student_id && collegeID && (input.classList.contains('input-grade') || input.classList.contains('input-score'))) {
        fetch(SERVER + '/26susi_student_grade_update', {
            method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id, college_id: collegeID, 등급: tbody.querySelector('.input-grade').value, 내신점수: tbody.querySelector('.input-score').value })
        });
    }
    updateAllScores(tbody);
}

document.getElementById('counselForm').onsubmit = async function(e) {
    e.preventDefault();
    const msgEl = document.getElementById('msg');
    msgEl.textContent = '저장 중...';
    const student_id = document.getElementById('studentSelect').value;
    const collegesArr = [];
    document.querySelectorAll('#collegeTbody .row-group').forEach(tbody => {
        const 대학ID = getCollegeIDByTbody(tbody); if (!대학ID) return;
        const practicalGroups = tbody.querySelectorAll('.practical-group');
        let 기록 = [], 점수 = [];
        for(let i = 0; i < 7; i++) {
            const group = practicalGroups[i];
            기록.push(group?.querySelector('.input-record')?.value || null);
            점수.push(group?.querySelector('.input-score-only')?.value || null);
        }
        collegesArr.push({
            대학ID, 실기ID: getPracticalIDByCollegeID(대학ID),
            내신등급: tbody.querySelector('.input-grade')?.value || null,
            내신점수: tbody.querySelector('.input-score')?.value || null,
            기록1: 기록[0], 점수1: 점수[0], 기록2: 기록[1], 점수2: 점수[1], 기록3: 기록[2], 점수3: 점수[2], 기록4: 기록[3], 점수4: 점수[3],
            기록5: 기록[4], 점수5: 점수[4], 기록6: 기록[5], 점수6: 점수[5], 기록7: 기록[6], 점수7: 점수[6],
            실기총점: tbody.querySelector('.input-total-score')?.value || null,
            합산점수: tbody.querySelector('.합산점수')?.value || null,
        });
    });
    const saveColleges = fetch(SERVER + '/26susi_counsel_college_save_multi', {
        method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ student_id, colleges: collegesArr })
    });
    const saveMemo = fetch(SERVER + '/26susi_counsel_memo_save', {
        method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ student_id, memo: document.getElementById('counselMemo').value })
    });
    try {
        const [collegeRes, memoRes] = await Promise.all([saveColleges, saveMemo]);
        const allSuccess = (await collegeRes.json()).success && (await memoRes.json()).success;
        msgEl.textContent = ''; 
        if (allSuccess) {
            Swal.fire({ imageUrl: 'https://github.com/seanyjeong/supermax/blob/main/maxmax.png?raw=true', imageWidth: 120, title: '저장 완료!', text: `${studentMap[student_id].이름} 학생의 상담내용이 저장되었습니다.`, confirmButtonColor: '#4364f7' });
        } else { Swal.fire({ icon: 'error', title: '저장 실패', text: '데이터 저장 중 문제가 발생했습니다.' }); }
    } catch(err) { Swal.fire({ icon: 'error', title: '오류 발생', text: '서버와 통신 중 오류가 발생했습니다.' }); }
};

document.getElementById('studentSelect').addEventListener('change', function() { loadCounselData(this.value); });

async function loadCounselData(student_id) {
    Swal.fire({ title: '학생 정보 로딩 중...', html: `<img src="https://github.com/seanyjeong/supermax/blob/main/maxmax.png?raw=true" alt="로딩 로고" style="width: 120px; margin-bottom: 20px;"><div class="swal2-spinner"></div>`, allowOutsideClick: false, showConfirmButton: false, });
    const tbodyContainer = document.getElementById('collegeTbody'), memoTextarea = document.getElementById('counselMemo');
    tbodyContainer.innerHTML = ''; memoTextarea.value = '';
    try {
        const [collegeRes, memoRes] = await Promise.all([
            fetch(`${SERVER}/26susi_counsel_college_load?student_id=${student_id}`, { headers: { Authorization: 'Bearer ' + token } }).then(res => res.json()),
            fetch(`${SERVER}/26susi_counsel_memo_load?student_id=${student_id}`, { headers: { Authorization: 'Bearer ' + token } }).then(res => res.json())
        ]);
        if (memoRes.success) { memoTextarea.value = memoRes.memo || ''; }
        if (!collegeRes.success || !collegeRes.colleges || collegeRes.colleges.length === 0) { addCollegeRow(); return; }
        for (let item of collegeRes.colleges) {
            const c = colleges.find(c => c.대학ID === item.대학ID); if (!c) continue;
            addCollegeRow();
            await new Promise(r => setTimeout(r, 50)); 
            const group = document.querySelector('#collegeTbody .row-group:last-child');
            const collegeSel = group.querySelector('.sel-college'); collegeSel.value = c.대학명; await onCollegeNameChange(collegeSel);
            const majorSel = group.querySelector('.sel-major'); majorSel.value = c.학과명; await onMajorChange(majorSel);
            const typeSel = group.querySelector('.sel-type'); typeSel.value = c.전형명; await onTypeChange(typeSel); 
            const practicalGroups = group.querySelectorAll('.practical-group');
            for (let i = 0; i < 7; i++) {
                if (practicalGroups[i]?.querySelector('.input-record') && item[`기록${i+1}`]) {
                    practicalGroups[i].querySelector('.input-record').value = item[`기록${i+1}`];
                }
            }
            const firstRecordInput = group.querySelector('.input-record');
            if (firstRecordInput?.value) { await onRecordInputChange(firstRecordInput); }
        }
    } catch (error) { Swal.fire({ icon: 'error', title: '오류 발생', text: '상담 정보를 불러오는 데 실패했습니다.' }); } 
    finally { Swal.close(); }
}

async function downloadPDF() {
    Swal.fire({ title: 'PDF 문서를 만들고 있어요', html: '<div class="swal2-spinner"></div>', allowOutsideClick: false, showConfirmButton: false, });
    try {
        const element = document.getElementById('captureArea');
        const studentId = document.getElementById('studentSelect').value;
        const studentName = studentMap[studentId] ? studentMap[studentId].이름 : '학생';
        const titleElement = document.createElement('h2');
        titleElement.id = 'pdf-temp-title';
        titleElement.textContent = `${studentName} 학생 상담요약`;
        element.classList.add('pdf-export-mode');
        element.prepend(titleElement);
        const canvas = await window.html2canvas(element, { scale: 1.5, useCORS: true, });
        element.classList.remove('pdf-export-mode');
        titleElement.remove();
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
        const A4_WIDTH_MM = 210, A4_HEIGHT_MM = 297, MARGIN_MM = 15;
        const availableWidth = A4_WIDTH_MM - (2 * MARGIN_MM), availableHeight = A4_HEIGHT_MM - (2 * MARGIN_MM);
        const imgRatio = canvas.width / canvas.height;
        let pdfImgWidth = availableWidth, pdfImgHeight = pdfImgWidth / imgRatio;
        if (pdfImgHeight > availableHeight) { pdfImgHeight = availableHeight; pdfImgWidth = pdfImgHeight * imgRatio; }
        const xPosition = (A4_WIDTH_MM - pdfImgWidth) / 2, yPosition = MARGIN_MM;
        doc.addImage(imgData, 'JPEG', xPosition, yPosition, pdfImgWidth, pdfImgHeight);
        doc.save(`${studentName}_상담요약.pdf`);
        Swal.fire({ icon: 'success', title: 'PDF 생성 완료!', showConfirmButton: false, timer: 1500 });
    } catch (error) { Swal.fire({ icon: 'error', title: '오류 발생', text: 'PDF를 만드는 중 문제가 발생했습니다.' }); }
}

function getCollegeID(대학명, 학과명, 전형명) { const c = colleges.find(c => c.대학명 === 대학명 && c.학과명 === 학과명 && c.전형명 === 전형명); return c?.대학ID || null; }
function getCollegeIDByTbody(tbody) { const c = tbody.querySelector('.sel-college').value, m = tbody.querySelector('.sel-major').value, t = tbody.querySelector('.sel-type').value; return c&&m&&t ? getCollegeID(c,m,t) : null; }
function getPracticalIDByCollegeID(대학ID) { const c = colleges.find(c => c.대학ID === 대학ID); return c?.실기ID || null; }

function closeScoreTablePopup() { document.getElementById('scoreTableModal').style.display = 'none'; }
async function openScoreTablePopup(btn) {
    const tbody = btn.closest('tbody.row-group'), collegeID = getCollegeIDByTbody(tbody);
    const matched = colleges.find(c => c.대학ID === collegeID);
    if (!matched || !matched.실기ID) { Swal.fire('알림', '대학, 학과, 전형을 모두 선택해야 배점표를 볼 수 있습니다.', 'warning'); return; }
    const modal = document.getElementById('scoreTableModal');
    document.getElementById('modalTitle').textContent = `${matched.대학명} - ${matched.학과명} (${matched.전형명}) 배점표`;
    const container = document.getElementById('modalTableContainer'); container.innerHTML = '로딩 중...';
    modal.style.display = 'block';
    try {
        const res = await fetch(`${SERVER}/26susi_get_score_table?실기ID=${matched.실기ID}`);
        const data = await res.json();
        if (data.success) { renderPopupScoreTable(data.events, container); } 
        else { container.innerHTML = '배점표를 불러오는 데 실패했습니다.'; }
    } catch (e) { container.innerHTML = '배점표 로드 중 오류 발생.'; }
}
function renderPopupScoreTable(events, container) {
    let finalHTML = '';
    Object.keys(events).forEach(name => {
        const { 남, 여 } = events[name];
        const allScores = new Set([...남.map(i => i.배점), ...여.map(i => i.배점)]);
        const sortedScores = Array.from(allScores).sort((a,b)=>Number(b)-Number(a));
        const scoreMap = { 남: new Map(남.map(i=>[i.배점, i.기록])), 여: new Map(여.map(i=>[i.배점, i.기록])) };
        let tableHTML = `<table><thead><tr><th colspan="3">${name}</th></tr><tr><th>배점</th><th>남</th><th>여</th></tr></thead><tbody>`;
        sortedScores.forEach(score => { tableHTML += `<tr><td>${score}</td><td>${scoreMap.남.get(score) || '-'}</td><td>${scoreMap.여.get(score) || '-'}</td></tr>`; });
        tableHTML += '</tbody></table>';
        finalHTML += tableHTML;
    });
    container.innerHTML = finalHTML;
}

loadData();
  </script>
</body>
</html>
