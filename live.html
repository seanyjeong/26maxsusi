<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>26ìˆ˜ì‹œ ì‹¤ì‹œê°„ í˜„í™©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <style>
        :root { 
            --primary-color: #4364f7; --primary-light: #eef2ff; --secondary-color: #6a8eff; 
            --light-gray: #f8f9fa; --medium-gray: #e9ecef; --dark-gray: #1e293b; 
            --text-primary: #334155; --text-secondary: #64748b; --border-radius: 8px; 
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--light-gray); padding: 20px; }
        .section { background-color: white; padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: var(--card-shadow); }
        .controls-wrap { display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 10px; }
        .filter-wrap { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        select, button { padding: 8px 12px; border-radius: 4px; border: 1px solid var(--medium-gray); font-size: 14px; }
        #result-title-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--medium-gray); padding-bottom: 10px; }
        #result-title { margin: 0; font-size: 1.3em; font-weight: 500; color: var(--dark-gray); }
        .swal2-html-container { text-align: left !important; }

        .btn-excel { background: linear-gradient(135deg, #1D6F42, #28a745); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-excel:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(29,111,66,0.3); }

        /* --- ë°ìŠ¤í¬íƒ‘ í…Œì´ë¸” ìŠ¤íƒ€ì¼ --- */
        #desktop-view { overflow-x: auto; }
        #desktop-view table { width: 100%; border-collapse: collapse; }
        #desktop-view th, #desktop-view td { border: 1px solid var(--medium-gray); padding: 10px; text-align: center; font-size: 13px; vertical-align: middle; white-space: nowrap; }
        #desktop-view th { background-color: var(--primary-color); color: white; font-weight: 500; position: sticky; top: -1px; z-index: 10; }
        #desktop-view thead tr:nth-child(2) th { top: 40px; }
        #desktop-view .col-record, #desktop-view .col-score { width: 70px; min-width: 60px; }
        #desktop-view .rank-top3 { font-weight: bold; color: var(--primary-color); }
        #desktop-view .my-branch-row { background-color: var(--primary-light); font-weight: 500; }

        /* --- ëª¨ë°”ì¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ --- */
        #mobile-view { display: none; }
        #mobile-view .student-item { background: white; padding: 18px; border-radius: 12px; margin-bottom: 12px; box-shadow: var(--card-shadow); cursor: pointer; display: flex; align-items: center; gap: 15px; }
        #mobile-view .rank { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); width: 40px; text-align: center; }
        #mobile-view .student-info { flex: 1; }
        #mobile-view .student-main-info { display: flex; align-items: center; font-weight: 600; font-size: 1.05rem; margin-bottom: 6px; }
        #mobile-view .student-branch { font-size: 0.8rem; color: var(--text-secondary); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
        #mobile-view .student-scores { font-size: 0.85rem; color: var(--text-secondary); display: flex; flex-wrap: wrap; gap: 10px; }
        #mobile-view .my-branch-item { background-color: var(--primary-light); border: 1px solid var(--primary-color); }
        .swal-results-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        .swal-results-table th, .swal-results-table td { border: 1px solid var(--medium-gray); padding: 10px; text-align: center; }
        .swal-results-table th { background-color: var(--primary-light); color: var(--primary-color); font-weight: 600; }
        .swal-results-table .total-score { font-weight: bold; color: var(--primary-color); }

        .grade-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; color: white; min-width: 28px; text-align: center; }
        .grade-1, .grade-2 { background: #4364f7; }
        .grade-3, .grade-4 { background: #28a745; }
        .grade-5, .grade-6 { background: #f59e0b; }
        .grade-7, .grade-8, .grade-9 { background: #ef4444; }
        .grade-none { background: #cbd5e1; color: #64748b; }

        @media (max-width: 768px) {
            body { padding: 8px; }
            .section { padding: 12px; }
            #desktop-view { display: none; }
            #mobile-view { display: block; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
             <h2 id="main-title">26ìˆ˜ì‹œ ì‹¤ì‹œê°„ í˜„í™© (ì „ì²´ êµìœ¡ì›)</h2>
            <div class="controls-wrap">
                <div class="filter-wrap">
                    <div><label for="sel-college">ëŒ€í•™ëª…</label><select id="sel-college" onchange="onCollegeChange()"></select></div>
                    <div><label for="sel-major">í•™ê³¼ëª…</label><select id="sel-major" onchange="onMajorChange()" disabled></select></div>
                    <div><label for="sel-type">ì „í˜•ëª…</label><select id="sel-type" onchange="onTypeChange()"></select></div>
                </div>
                <button class="btn-excel" onclick="downloadAllExcel()"><i class="fas fa-file-excel"></i> ì „ì²´ ìˆ˜í•© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>

        <div class="section">
             <div id="result-title-container">
                <h3 id="result-title">ëŒ€í•™/í•™ê³¼/ì „í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</h3>
            </div>
            <div id="desktop-view">
                <table id="resultTable">
                    <thead></thead>
                    <tbody id="resultTbody"></tbody>
                </table>
            </div>
            <div id="mobile-view">
                <div id="student-list-container"></div>
            </div>
        </div>
    </div>

<script>
    const SERVER = 'https://supermax.kr';
    const token = localStorage.getItem('token');
    if (!token) location.href = 'login.html';

    let colleges = [], collegeGroups = {};
    let loggedInUserBranch = '';
    let studentDataMap = new Map();
    let currentEvents = [];

    function gradeBadge(grade) {
        if (!grade && grade !== 0) return '<span class="grade-badge grade-none">-</span>';
        const g = Math.round(parseFloat(grade));
        const cls = (g >= 1 && g <= 9) ? 'grade-' + g : 'grade-none';
        return `<span class="grade-badge ${cls}">${grade}</span>`;
    }

    // init ë° ë“œë¡­ë‹¤ìš´ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ì´ì „ê³¼ ë™ì¼ (ìƒëµ)
    async function init() {
        const [profileRes, collegeRes] = await Promise.all([
            fetch(`${SERVER}/26susi/profile`, { headers: { 'Authorization': 'Bearer ' + token } }).then(res => res.json()),
            fetch(`${SERVER}/26susi_college_list`, { headers: { 'Authorization': 'Bearer ' + token } }).then(res => res.json())
        ]);
        if (profileRes.success && profileRes.user) { loggedInUserBranch = profileRes.user.branch; }
        if (collegeRes.success) { colleges = collegeRes.colleges; groupColleges(); populateCollegeSelect(); onTypeChange(); }
    }
    function groupColleges() { colleges.forEach(c => { if (!collegeGroups[c.ëŒ€í•™ëª…]) collegeGroups[c.ëŒ€í•™ëª…] = {}; if (!collegeGroups[c.ëŒ€í•™ëª…][c.í•™ê³¼ëª…]) collegeGroups[c.ëŒ€í•™ëª…][c.í•™ê³¼ëª…] = []; collegeGroups[c.ëŒ€í•™ëª…][c.í•™ê³¼ëª…].push(c.ì „í˜•ëª…); }); }
    function populateCollegeSelect() { document.getElementById('sel-college').innerHTML = '<option value="">ì„ íƒ</option>' + Object.keys(collegeGroups).sort().map(c => `<option value="${c}">${c}</option>`).join(''); }
    function onCollegeChange() { const c = document.getElementById('sel-college').value; const s = document.getElementById('sel-major'); s.innerHTML = '<option value="">ì„ íƒ</option>'; document.getElementById('sel-type').innerHTML = '<option value="">ì„ íƒ</option>'; if (c && collegeGroups[c]) { s.innerHTML += Object.keys(collegeGroups[c]).sort().map(m => `<option value="${m}">${m}</option>`).join(''); s.disabled = false; } else { s.disabled = true; document.getElementById('sel-type').disabled = true; } onTypeChange(); }
    function onMajorChange() { const c = document.getElementById('sel-college').value; const m = document.getElementById('sel-major').value; const t = document.getElementById('sel-type'); t.innerHTML = '<option value="">ì„ íƒ</option>'; if (m && collegeGroups[c]?.[m]) { t.innerHTML += collegeGroups[c][m].sort().map(type => `<option value="${type}">${type}</option>`).join(''); t.disabled = false; } else { t.disabled = true; } onTypeChange(); }
    function onTypeChange() { searchRanking(); }

    async function searchRanking() {
        const c = document.getElementById('sel-college').value, m = document.getElementById('sel-major').value, t = document.getElementById('sel-type').value;
        const resultTitle = document.getElementById('result-title');
        
        if (!c || !m || !t) {
            renderDesktopTable([], []);
            renderMobileList([]);
            resultTitle.textContent = 'ëŒ€í•™/í•™ê³¼/ì „í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
            return;
        }

        const currentCollege = colleges.find(col => col.ëŒ€í•™ëª… === c && col.í•™ê³¼ëª… === m && col.ì „í˜•ëª… === t);
        if (!currentCollege) return;
        
        resultTitle.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ì „ì²´ ì§€ì  ë°ì´í„° ì¡°íšŒ ì¤‘...`;
        
        const res = await fetch(`${SERVER}/26susi/realtime-rank-by-college?college_id=${currentCollege.ëŒ€í•™ID}`, { headers: { 'Authorization': 'Bearer ' + token } });
        const data = await res.json();
        
        if (data.success) {
            currentEvents = data.events;
            resultTitle.textContent = `[${c} ${m} (${t})] ì‹¤ì‹œê°„ ìˆœìœ„ (ì´ ${data.ranking.length}ëª…)`;
            renderDesktopTable(data.ranking, data.events);
            renderMobileList(data.ranking);
        } else {
            Swal.fire('ì˜¤ë¥˜', 'ë°ì´í„° ì¡°íšŒ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            renderDesktopTable([], []);
            renderMobileList([]);
        }
    }

    // â–¼â–¼â–¼â–¼â–¼ ì—¬ê¸°ê°€ ìˆ˜ì •ëœ renderDesktopTable í•¨ìˆ˜ â–¼â–¼â–¼â–¼â–¼
    function renderDesktopTable(rankingData, events = []) {
        const thead = document.getElementById('resultTable').querySelector('thead');
        const tbody = document.getElementById('resultTable').querySelector('tbody');
        
        let headerRow1HTML = `<tr><th rowspan="2">ìˆœìœ„</th><th rowspan="2">ì§€ì </th><th rowspan="2">ì´ë¦„</th><th rowspan="2">ì„±ë³„</th>`;
        events.forEach(event => {
            headerRow1HTML += `<th colspan="2">${event}</th>`;
        });
        headerRow1HTML += `<th rowspan="2">ë‚´ì‹ ë“±ê¸‰</th><th rowspan="2">ë‚´ì‹ ì ìˆ˜</th><th rowspan="2">ì‹¤ê¸°ì´ì </th><th rowspan="2">í•©ì‚°ì ìˆ˜</th><th rowspan="2">ìµœì´ˆí•©</th><th rowspan="2">ìµœì¢…í•©</th></tr>`;

        let headerRow2HTML = `<tr>`;
        events.forEach(event => {
            headerRow2HTML += `<th class="col-record">ê¸°ë¡</th><th class="col-score">ì ìˆ˜</th>`;
        });
        headerRow2HTML += `</tr>`;
        
        thead.innerHTML = headerRow1HTML + headerRow2HTML;
        
        const totalColumns = 4 + (events.length * 2) + 6;

        if (rankingData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${totalColumns}">í•´ë‹¹ ì „í˜•ì— ìˆ˜í•©ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            return;
        }
        
        tbody.innerHTML = rankingData.map(student => {
            const isMyBranch = student.ì§€ì ëª… === loggedInUserBranch;
            const rowClass = isMyBranch ? 'my-branch-row' : '';
            const rankClass = student.ìˆœìœ„ <= 3 ? 'rank-top3' : '';
            
            let rowHTML = `<tr class="${rowClass}"><td class="${rankClass}">${student.ìˆœìœ„}</td><td>${student.ì§€ì ëª…}</td><td>${student.ì´ë¦„}</td><td>${student.ì„±ë³„}</td>`;
            for (let i = 1; i <= events.length; i++) {
                rowHTML += `<td class="col-record">${student['ê¸°ë¡'+i] || '-'}</td><td class="col-score">${student['ì ìˆ˜'+i] || '-'}</td>`;
            }
            rowHTML += `
                <td>${gradeBadge(student.ë‚´ì‹ ë“±ê¸‰)}</td>
                <td>${student.ë‚´ì‹ ì ìˆ˜ || '-'}</td>
                <td>${student.ì‹¤ê¸°ì´ì  !== null ? parseFloat(student.ì‹¤ê¸°ì´ì ).toFixed(2) : '-'}</td>
                <td><strong>${student.í•©ì‚°ì ìˆ˜ !== null ? parseFloat(student.í•©ì‚°ì ìˆ˜).toFixed(2) : '-'}</strong></td>
                <td>${student.ìµœì´ˆí•©ì—¬ë¶€ || '-'}</td>
                <td>${student.ìµœì¢…í•©ì—¬ë¶€ || '-'}</td>
            </tr>`;
            return rowHTML;
        }).join('');
    }

    // renderMobileList í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼ (íŒì—…ì—ì„œ ë³´ì—¬ì¤„ ê²ƒì´ë¯€ë¡œ)
    function renderMobileList(rankingData) {
        const container = document.getElementById('student-list-container');
        studentDataMap.clear();

        if (rankingData.length === 0) {
            container.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">í•´ë‹¹ ì „í˜•ì— ìˆ˜í•©ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        container.innerHTML = rankingData.map(student => {
            studentDataMap.set(student.í•™ìƒID, student);
            const isMyBranch = student.ì§€ì ëª… === loggedInUserBranch;
            return `
                <div class="student-item ${isMyBranch ? 'my-branch-item' : ''}" onclick="openDetailModal(${student.í•™ìƒID})">
                    <div class="rank">${student.ìˆœìœ„}</div>
                    <div class="student-info">
                        <div class="student-main-info">
                            <span>${student.ì´ë¦„} (${student.ì„±ë³„})</span>
                            <span class="student-branch">${student.ì§€ì ëª…}</span>
                        </div>
                        <div class="student-scores">
                            <span>${gradeBadge(student.ë‚´ì‹ ë“±ê¸‰)}</span>
                            <span>ë‚´ì‹ : ${student.ë‚´ì‹ ì ìˆ˜ || '-'}</span>
                            <span>ì‹¤ê¸°: ${student.ì‹¤ê¸°ì´ì  !== null ? student.ì‹¤ê¸°ì´ì .toFixed(2) : '-'}</span>
                            <span>í•©ì‚°: ${student.í•©ì‚°ì ìˆ˜ !== null ? student.í•©ì‚°ì ìˆ˜.toFixed(2) : '-'}</span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
            `;
        }).join('');
    }

    // â–¼â–¼â–¼â–¼â–¼ ì—¬ê¸°ê°€ ìˆ˜ì •ëœ openDetailModal í•¨ìˆ˜ â–¼â–¼â–¼â–¼â–¼
    function openDetailModal(studentId) {
        const student = studentDataMap.get(studentId);
        if (!student) return;

        let detailHTML = ``;
        if (currentEvents.length > 0) {
            detailHTML += `<table class="swal-results-table"><thead><tr><th>ì¢…ëª©</th><th>ê¸°ë¡</th><th>ì ìˆ˜</th></tr></thead><tbody>`;
            for (let i = 0; i < currentEvents.length; i++) {
                const eventName = currentEvents[i];
                detailHTML += `<tr><td>${eventName}</td><td>${student['ê¸°ë¡'+(i+1)] || '-'}</td><td>${student['ì ìˆ˜'+(i+1)] || '-'}</td></tr>`;
            }
            detailHTML += `</tbody></table>`;
        }
        
        detailHTML += `<table class="swal-results-table" style="margin-top: 10px;">
            <tr><th>ë‚´ì‹ ë“±ê¸‰</th><td>${gradeBadge(student.ë‚´ì‹ ë“±ê¸‰)}</td></tr>
            <tr><th>ë‚´ì‹ ì ìˆ˜</th><td>${student.ë‚´ì‹ ì ìˆ˜ || '-'}</td></tr>
            <tr><th>ì‹¤ê¸° ì´ì </th><td class="total-score">${student.ì‹¤ê¸°ì´ì  !== null ? student.ì‹¤ê¸°ì´ì .toFixed(2) : '-'} ì </td></tr>
            <tr><th>í•©ì‚° ì´ì </th><td class="total-score">${student.í•©ì‚°ì ìˆ˜ !== null ? student.í•©ì‚°ì ìˆ˜.toFixed(2) : '-'} ì </td></tr>
        </table>`;

        // í•©ê²© í˜„í™© í…Œì´ë¸” ì¶”ê°€
        detailHTML += `<div style="margin-top:20px; text-align:center; font-weight:bold; color:var(--dark-gray);">í•©ê²© í˜„í™©</div>
        <table class="swal-results-table" style="margin-top: 5px;">
            <thead><tr><th>ìµœì´ˆ í•©ê²©</th><th>ìµœì¢… í•©ê²©</th></tr></thead>
            <tbody><tr>
                <td>${student.ìµœì´ˆí•©ì—¬ë¶€ || '-'}</td>
                <td>${student.ìµœì¢…í•©ì—¬ë¶€ || '-'}</td>
            </tr></tbody>
        </table>`;

        Swal.fire({
            title: `${student.ì´ë¦„} í•™ìƒ ìƒì„¸ ì •ë³´`,
            html: detailHTML,
            confirmButtonText: 'ë‹«ê¸°'
        });
    }
    
    async function downloadAllExcel() {
        Swal.fire({
            title: 'ğŸ“Š ì „ì²´ ìˆ˜í•© ë°ì´í„° ìˆ˜ì§‘ ì¤‘...',
            html: `<div style="margin-top:10px">
                <div id="dl-text" style="font-size:14px;color:#334155">ì¤€ë¹„ ì¤‘...</div>
                <div style="background:#e9ecef;border-radius:8px;height:20px;margin-top:10px;overflow:hidden">
                    <div id="dl-bar" style="background:linear-gradient(90deg,#1D6F42,#28a745);height:100%;width:0%;transition:width 0.3s;border-radius:8px"></div>
                </div>
            </div>`,
            allowOutsideClick: false,
            showConfirmButton: false
        });

        try {
            const allData = [];
            for (let i = 0; i < colleges.length; i++) {
                const col = colleges[i];
                const pct = Math.round(((i + 1) / colleges.length) * 100);
                const dt = document.getElementById('dl-text');
                const db = document.getElementById('dl-bar');
                if (dt) dt.textContent = `${i + 1}/${colleges.length} â€” ${col.ëŒ€í•™ëª…} ${col.í•™ê³¼ëª…}`;
                if (db) db.style.width = pct + '%';

                try {
                    const res = await fetch(`${SERVER}/26susi/realtime-rank-by-college?college_id=${col.ëŒ€í•™ID}`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    const data = await res.json();
                    if (data.success && data.ranking && data.ranking.length > 0) {
                        allData.push({ ëŒ€í•™ëª…: col.ëŒ€í•™ëª…, í•™ê³¼ëª…: col.í•™ê³¼ëª…, ì „í˜•ëª…: col.ì „í˜•ëª…, ranking: data.ranking, events: data.events || [] });
                    }
                } catch (e) { console.error('Fetch fail:', col.ëŒ€í•™ëª…, e); }
            }

            if (allData.length === 0) {
                Swal.fire('ì•ˆë‚´', 'ìˆ˜í•©ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                return;
            }

            // Sort by ëŒ€í•™ëª… > í•™ê³¼ëª…
            allData.sort((a, b) => a.ëŒ€í•™ëª….localeCompare(b.ëŒ€í•™ëª…, 'ko') || a.í•™ê³¼ëª….localeCompare(b.í•™ê³¼ëª…, 'ko'));

            const wb = new ExcelJS.Workbook();
            wb.creator = 'MAX ìˆ˜ì‹œ ì‹œìŠ¤í…œ';
            wb.created = new Date();

            // Color palette
            const C = {
                primary: 'FF4364F7', white: 'FFFFFFFF', dark: 'FF1E293B',
                gray: 'FF64748B', lightBg: 'FFF8FAFC', border: 'FFD1D5DB',
                green: 'FF1D6F42', accent: 'FFEEF2FF'
            };
            const border = {
                top: { style: 'thin', color: { argb: C.border } },
                left: { style: 'thin', color: { argb: C.border } },
                bottom: { style: 'thin', color: { argb: C.border } },
                right: { style: 'thin', color: { argb: C.border } }
            };

            // Group by ëŒ€í•™ëª…
            const byUniv = {};
            allData.forEach(d => {
                if (!byUniv[d.ëŒ€í•™ëª…]) byUniv[d.ëŒ€í•™ëª…] = [];
                byUniv[d.ëŒ€í•™ëª…].push(d);
            });
            const univNames = Object.keys(byUniv).sort((a, b) => a.localeCompare(b, 'ko'));

            // Sheet name sanitizer (Excel: max 31 chars, no []:*?/\)
            const sanitize = (name) => name.replace(/[[\]:*?/\\]/g, '').substring(0, 31);

            // ========== 1) ëª©ì°¨ ì‹œíŠ¸ ==========
            const tocWs = wb.addWorksheet('ëª©ì°¨', { properties: { defaultRowHeight: 24 } });
            const tocTitle = tocWs.addRow(['26ìˆ˜ì‹œ ì „ì²´ ìˆ˜í•©ê²°ê³¼ â€” ëª©ì°¨']);
            tocTitle.height = 42;
            tocWs.mergeCells(tocTitle.number, 1, tocTitle.number, 5);
            tocTitle.getCell(1).font = { name: 'Noto Sans KR', size: 18, bold: true, color: { argb: C.primary } };
            tocTitle.getCell(1).alignment = { vertical: 'middle' };

            const tocDate = tocWs.addRow([`ë‹¤ìš´ë¡œë“œ: ${new Date().toLocaleString('ko-KR')}`]);
            tocWs.mergeCells(tocDate.number, 1, tocDate.number, 5);
            tocDate.getCell(1).font = { name: 'Noto Sans KR', size: 10, color: { argb: C.gray } };

            const totalStudents = allData.reduce((s, d) => s + d.ranking.length, 0);
            const tocSummary = tocWs.addRow([`ì´ ${univNames.length}ê°œ ëŒ€í•™  |  ${allData.length}ê°œ í•™ê³¼/ì „í˜•  |  ${totalStudents}ëª…`]);
            tocWs.mergeCells(tocSummary.number, 1, tocSummary.number, 5);
            tocSummary.getCell(1).font = { name: 'Noto Sans KR', size: 11, bold: true };

            tocWs.addRow([]);

            // í•©ê²©ì ëª…ë‹¨ ë°”ë¡œê°€ê¸° (ëª©ì°¨ ìƒë‹¨ - ëŒ€í•™ ëª©ë¡ ìœ„)
            const passLinkRow = tocWs.addRow(['']);
            tocWs.mergeCells(passLinkRow.number, 1, passLinkRow.number, 5);
            const passLink = passLinkRow.getCell(1);
            passLink.value = { text: 'í•©ê²©ì ëª…ë‹¨ ì‹œíŠ¸ë¡œ ì´ë™ â†’', hyperlink: "#'í•©ê²©ì ëª…ë‹¨'!A1" };
            passLink.font = { name: 'Noto Sans KR', size: 13, bold: true, color: { argb: C.white }, underline: true };
            passLink.alignment = { horizontal: 'center', vertical: 'middle' };
            passLinkRow.height = 38;
            passLink.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: C.green } };
            passLink.border = border;

            tocWs.addRow([]);

            // Table header
            const tocHeader = tocWs.addRow(['No.', 'ëŒ€í•™ëª…', 'í•™ê³¼ ìˆ˜', 'ì´ ì¸ì›', 'ë°”ë¡œê°€ê¸°']);
            tocHeader.height = 30;
            tocHeader.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: C.primary } };
                cell.font = { name: 'Noto Sans KR', size: 11, bold: true, color: { argb: C.white } };
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.border = border;
            });

            univNames.forEach((uName, idx) => {
                const sections = byUniv[uName];
                const stuCount = sections.reduce((s, d) => s + d.ranking.length, 0);
                const sheetName = sanitize(uName);
                const tocRow = tocWs.addRow([idx + 1, uName, sections.length, stuCount, uName]);
                const isEven = idx % 2 === 0;
                tocRow.eachCell((cell, colNum) => {
                    cell.font = { name: 'Noto Sans KR', size: 10 };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = border;
                    if (isEven) cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: C.lightBg } };
                });
                // Hyperlink on ë°”ë¡œê°€ê¸° column
                const linkCell = tocRow.getCell(5);
                linkCell.value = { text: 'â†’ ì´ë™', hyperlink: `#'${sheetName}'!A1` };
                linkCell.font = { name: 'Noto Sans KR', size: 10, bold: true, color: { argb: C.primary }, underline: true };
            });

            tocWs.getColumn(1).width = 6;
            tocWs.getColumn(2).width = 25;
            tocWs.getColumn(3).width = 10;
            tocWs.getColumn(4).width = 10;
            tocWs.getColumn(5).width = 12;

            // ========== 2) ëŒ€í•™ë³„ ì‹œíŠ¸ ==========
            for (const uName of univNames) {
                const sections = byUniv[uName];
                const sheetName = sanitize(uName);
                const ws = wb.addWorksheet(sheetName, { properties: { defaultRowHeight: 22 } });

                // Sheet title
                const r1 = ws.addRow([uName]);
                r1.height = 38;
                ws.mergeCells(r1.number, 1, r1.number, 13);
                r1.getCell(1).font = { name: 'Noto Sans KR', size: 16, bold: true, color: { argb: C.primary } };
                r1.getCell(1).alignment = { vertical: 'middle' };

                // Back to TOC link
                const backRow = ws.addRow(['â† ëª©ì°¨ë¡œ ëŒì•„ê°€ê¸°']);
                ws.mergeCells(backRow.number, 1, backRow.number, 4);
                backRow.getCell(1).value = { text: 'â† ëª©ì°¨ë¡œ ëŒì•„ê°€ê¸°', hyperlink: "#'ëª©ì°¨'!A1" };
                backRow.getCell(1).font = { name: 'Noto Sans KR', size: 10, color: { argb: C.primary }, underline: true };

                ws.addRow([]);

                let maxCols = 0;

                for (const section of sections) {
                    const evtCount = section.events.length;
                    const totalCols = 4 + evtCount * 2 + 6;
                    if (totalCols > maxCols) maxCols = totalCols;

                    // Section header
                    const secRow = ws.addRow([`${section.í•™ê³¼ëª…}  â–¸  ${section.ì „í˜•ëª…}    (${section.ranking.length}ëª…)`]);
                    secRow.height = 32;
                    ws.mergeCells(secRow.number, 1, secRow.number, totalCols);
                    const secCell = secRow.getCell(1);
                    secCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: C.dark } };
                    secCell.font = { name: 'Noto Sans KR', size: 12, bold: true, color: { argb: C.white } };
                    secCell.alignment = { vertical: 'middle', horizontal: 'left' };

                    // Column headers
                    const headers = ['ìˆœìœ„', 'ì§€ì ', 'ì´ë¦„', 'ì„±ë³„'];
                    section.events.forEach(evt => { headers.push(evt + ' ê¸°ë¡', evt + ' ì ìˆ˜'); });
                    headers.push('ë‚´ì‹ ë“±ê¸‰', 'ë‚´ì‹ ì ìˆ˜', 'ì‹¤ê¸°ì´ì ', 'í•©ì‚°ì ìˆ˜', 'ìµœì´ˆí•©', 'ìµœì¢…í•©');

                    const hRow = ws.addRow(headers);
                    hRow.height = 28;
                    hRow.eachCell((cell) => {
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: C.primary } };
                        cell.font = { name: 'Noto Sans KR', size: 10, bold: true, color: { argb: C.white } };
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.border = border;
                    });

                    // Data rows
                    const totalColIdx = headers.indexOf('í•©ì‚°ì ìˆ˜') + 1;
                    const firstPassIdx = headers.indexOf('ìµœì´ˆí•©') + 1;
                    const finalPassIdx = headers.indexOf('ìµœì¢…í•©') + 1;

                    section.ranking.forEach((stu, idx) => {
                        const row = [stu.ìˆœìœ„, stu.ì§€ì ëª…, stu.ì´ë¦„, stu.ì„±ë³„];
                        for (let i = 1; i <= evtCount; i++) {
                            row.push(stu['ê¸°ë¡' + i] || '-');
                            row.push(stu['ì ìˆ˜' + i] != null ? Number(stu['ì ìˆ˜' + i]) : '-');
                        }
                        row.push(
                            stu.ë‚´ì‹ ë“±ê¸‰ || '-',
                            stu.ë‚´ì‹ ì ìˆ˜ != null ? Number(stu.ë‚´ì‹ ì ìˆ˜) : '-',
                            stu.ì‹¤ê¸°ì´ì  != null ? Number(parseFloat(stu.ì‹¤ê¸°ì´ì ).toFixed(2)) : '-',
                            stu.í•©ì‚°ì ìˆ˜ != null ? Number(parseFloat(stu.í•©ì‚°ì ìˆ˜).toFixed(2)) : '-',
                            stu.ìµœì´ˆí•©ì—¬ë¶€ || '-',
                            stu.ìµœì¢…í•©ì—¬ë¶€ || '-'
                        );

                        const dRow = ws.addRow(row);
                        const isEven = idx % 2 === 0;
                        dRow.eachCell((cell) => {
                            cell.font = { name: 'Noto Sans KR', size: 10 };
                            cell.alignment = { horizontal: 'center', vertical: 'middle' };
                            cell.border = border;
                            if (isEven) cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: C.lightBg } };
                        });

                        if (totalColIdx > 0) {
                            dRow.getCell(totalColIdx).font = { name: 'Noto Sans KR', size: 10, bold: true, color: { argb: C.primary } };
                        }
                        if (stu.ìˆœìœ„ <= 3) {
                            dRow.getCell(1).font = { name: 'Noto Sans KR', size: 10, bold: true, color: { argb: C.primary } };
                        }
                        [firstPassIdx, finalPassIdx].forEach(ci => {
                            if (ci > 0 && dRow.getCell(ci).value === 'í•©ê²©') {
                                dRow.getCell(ci).font = { name: 'Noto Sans KR', size: 10, bold: true, color: { argb: C.green } };
                            }
                        });
                    });

                    ws.addRow([]); // separator
                }

                // Column widths
                const widths = [6, 14, 10, 6];
                for (let i = 4; i < maxCols - 6; i++) widths.push(i % 2 === 0 ? 12 : 10);
                widths.push(10, 10, 10, 12, 8, 8);
                widths.forEach((w, i) => { if (ws.columns[i]) ws.columns[i].width = w; });
            }

            // ========== 3) í•©ê²©ì ëª…ë‹¨ ì‹œíŠ¸ ==========
            const passWs = wb.addWorksheet('í•©ê²©ì ëª…ë‹¨', { properties: { defaultRowHeight: 22 } });

            // Title
            const passTitle = passWs.addRow(['í•©ê²©ì ëª…ë‹¨']);
            passTitle.height = 42;
            passWs.mergeCells(passTitle.number, 1, passTitle.number, 6);
            passTitle.getCell(1).font = { name: 'Noto Sans KR', size: 18, bold: true, color: { argb: C.green } };
            passTitle.getCell(1).alignment = { vertical: 'middle' };

            const passBack = passWs.addRow(['â† ëª©ì°¨ë¡œ ëŒì•„ê°€ê¸°']);
            passWs.mergeCells(passBack.number, 1, passBack.number, 4);
            passBack.getCell(1).value = { text: 'â† ëª©ì°¨ë¡œ ëŒì•„ê°€ê¸°', hyperlink: "#'ëª©ì°¨'!A1" };
            passBack.getCell(1).font = { name: 'Noto Sans KR', size: 10, color: { argb: C.primary }, underline: true };

            // Collect all passers by ëŒ€í•™/í•™ê³¼/ì „í˜•
            const passSections = [];
            let totalPassCount = 0;
            for (const section of allData) {
                const passers = section.ranking.filter(s =>
                    s.ìµœì´ˆí•©ì—¬ë¶€ === 'í•©ê²©' || s.ìµœì¢…í•©ì—¬ë¶€ === 'í•©ê²©'
                );
                if (passers.length > 0) {
                    passSections.push({ ëŒ€í•™ëª…: section.ëŒ€í•™ëª…, í•™ê³¼ëª…: section.í•™ê³¼ëª…, ì „í˜•ëª…: section.ì „í˜•ëª…, passers });
                    totalPassCount += passers.length;
                }
            }

            const passSummary = passWs.addRow([`ì´ ${passSections.length}ê°œ í•™ê³¼/ì „í˜•  |  í•©ê²©ì ${totalPassCount}ëª…`]);
            passWs.mergeCells(passSummary.number, 1, passSummary.number, 6);
            passSummary.getCell(1).font = { name: 'Noto Sans KR', size: 11, bold: true };

            passWs.addRow([]);

            if (passSections.length === 0) {
                const noData = passWs.addRow(['í•©ê²©ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.']);
                passWs.mergeCells(noData.number, 1, noData.number, 6);
                noData.getCell(1).font = { name: 'Noto Sans KR', size: 12, color: { argb: C.gray } };
                noData.getCell(1).alignment = { horizontal: 'center' };
            } else {
                for (const sec of passSections) {
                    // Section header
                    const secRow = passWs.addRow([`${sec.ëŒ€í•™ëª…}  â–¸  ${sec.í•™ê³¼ëª…}  â–¸  ${sec.ì „í˜•ëª…}    (${sec.passers.length}ëª… í•©ê²©)`]);
                    secRow.height = 32;
                    passWs.mergeCells(secRow.number, 1, secRow.number, 6);
                    secRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: C.dark } };
                    secRow.getCell(1).font = { name: 'Noto Sans KR', size: 12, bold: true, color: { argb: C.white } };
                    secRow.getCell(1).alignment = { vertical: 'middle', horizontal: 'left' };

                    // Column headers
                    const pH = passWs.addRow(['No.', 'ì§€ì ', 'ì´ë¦„', 'ì„±ë³„', 'ìµœì´ˆí•©', 'ìµœì¢…í•©']);
                    pH.height = 28;
                    pH.eachCell(cell => {
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: C.green } };
                        cell.font = { name: 'Noto Sans KR', size: 10, bold: true, color: { argb: C.white } };
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.border = border;
                    });

                    // Data rows
                    sec.passers.forEach((stu, idx) => {
                        const pRow = passWs.addRow([idx + 1, stu.ì§€ì ëª…, stu.ì´ë¦„, stu.ì„±ë³„, stu.ìµœì´ˆí•©ì—¬ë¶€ || '-', stu.ìµœì¢…í•©ì—¬ë¶€ || '-']);
                        const isEven = idx % 2 === 0;
                        pRow.eachCell(cell => {
                            cell.font = { name: 'Noto Sans KR', size: 10 };
                            cell.alignment = { horizontal: 'center', vertical: 'middle' };
                            cell.border = border;
                            if (isEven) cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: C.lightBg } };
                        });
                        // Green highlight for í•©ê²© only
                        [5, 6].forEach(ci => {
                            if (pRow.getCell(ci).value === 'í•©ê²©') {
                                pRow.getCell(ci).font = { name: 'Noto Sans KR', size: 10, bold: true, color: { argb: C.green } };
                            }
                        });
                    });

                    passWs.addRow([]); // separator
                }
            }

            // Column widths for í•©ê²©ì ì‹œíŠ¸
            passWs.getColumn(1).width = 6;
            passWs.getColumn(2).width = 14;
            passWs.getColumn(3).width = 10;
            passWs.getColumn(4).width = 6;
            passWs.getColumn(5).width = 10;
            passWs.getColumn(6).width = 10;

            // Generate and download
            const buffer = await wb.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `26ìˆ˜ì‹œ_ì „ì²´ìˆ˜í•©ê²°ê³¼_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            Swal.fire({
                icon: 'success',
                title: 'ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!',
                html: `ì´ <b>${allData.length}ê°œ</b> ëŒ€í•™/í•™ê³¼<br><b>${totalStudents}ëª…</b> ìˆ˜í•© ì™„ë£Œ`,
                confirmButtonColor: '#4364f7'
            });
        } catch (err) {
            console.error('Excel error:', err);
            Swal.fire('ì˜¤ë¥˜', 'ì—‘ì…€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + err.message, 'error');
        }
    }

    init();
</script>
</body>
</html>
