<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>26수시 실시간 현황</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { 
            --primary-color: #4364f7; 
            --secondary-color: #6a8eff; 
            --light-gray: #f8f9fa; 
            --medium-gray: #e9ecef; 
            --dark-gray: #495057; 
            --border-radius: 6px; 
        }
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: var(--light-gray); 
            padding: 20px; 
        }
        h2 { 
            color: var(--primary-color); 
        }
        .section { 
            background-color: white; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
            overflow-x: auto;
        }
        .controls-wrap { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .filter-wrap { 
            display: flex; 
            gap: 15px; 
            align-items: flex-end; 
            flex-wrap: wrap; 
        }
        select, button { 
            padding: 8px 12px; 
            border-radius: 4px; 
            border: 1px solid var(--medium-gray); 
            font-size: 14px; 
        }
        #result-title-container { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            border-bottom: 2px solid var(--medium-gray); 
            padding-bottom: 10px; 
        }
        #result-title { 
            margin: 0; 
            font-size: 1.3em; 
            font-weight: 500; 
            color: var(--dark-gray); 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            table-layout: auto; 
        }
        th, td { 
            border: 1px solid var(--medium-gray); 
            padding: 10px; 
            text-align: center; 
            font-size: 13px; 
            vertical-align: middle; 
            white-space: nowrap; 
        }
        th { 
            background-color: var(--primary-color); 
            color: white; 
            font-weight: 500; 
            position: sticky; 
            top: 0;
            z-index: 10;
        }
        .rank-top3 { 
            font-weight: bold; 
            color: var(--primary-color); 
        }
        
        thead tr:nth-child(2) th {
            top: 41px;
        }
        
        .col-record, .col-score {
            width: 70px;
            min-width: 60px;
        }

        /* ▼▼▼▼▼ 여기 추가된 하이라이트 스타일 ▼▼▼▼▼ */
        .my-branch-row {
            background-color: #eef2ff; /* 은은한 파란색 계열 배경 */
            font-weight: 500; /* 글씨를 살짝 두껍게 */
        }
        .my-branch-row td {
            /* 기본 셀보다 미세하게 진한 테두리 색으로 구분감 부여 */
            border-color: #c7d2fe;
        }
        /* ▲▲▲▲▲ 여기까지 추가된 하이라이트 스타일 ▲▲▲▲▲ */
    </style>
</head>
<body>
    <div class="section">
        <h2 id="main-title">26수시 실시간 현황 (전체 교육원)</h2>
        <div class="controls-wrap">
            <div class="filter-wrap">
                <div><label for="sel-college">대학명</label><select id="sel-college" onchange="onCollegeChange()"></select></div>
                <div><label for="sel-major">학과명</label><select id="sel-major" onchange="onMajorChange()" disabled></select></div>
                <div><label for="sel-type">전형명</label><select id="sel-type" onchange="onTypeChange()"></select></div>
            </div>
        </div>
    </div>
    
    <div class="section">
        <div id="result-title-container">
            <h3 id="result-title">대학/학과/전형을 선택해주세요.</h3>
        </div>
        <table id="resultTable">
            <thead></thead>
            <tbody id="resultTbody"></tbody>
        </table>
    </div>

    <script>
    const SERVER = 'https://supermax.kr';
    const token = localStorage.getItem('token');
    if (!token) location.href = 'login.html';

    let colleges = [], collegeGroups = {};
    let loggedInUserBranch = ''; // ▼▼▼ 1. 로그인한 원장님 지점명을 저장할 변수 추가 ▼▼▼

    async function loadInitialData() {
        try {
            // Promise.all로 프로필 정보와 대학 목록을 동시에 요청
            const [profileRes, collegeRes] = await Promise.all([
                fetch(`${SERVER}/26susi/profile`, { headers: { 'Authorization': 'Bearer ' + token } }).then(res => res.json()),
                fetch(`${SERVER}/26susi_college_list`, { headers: { 'Authorization': 'Bearer ' + token } }).then(res => res.json())
            ]);

            // ▼▼▼ 2. API 응답에서 지점명을 가져와 변수에 저장 ▼▼▼
            if (profileRes.success && profileRes.user) {
                loggedInUserBranch = profileRes.user.branch;
            }

            if (collegeRes.success) {
                colleges = collegeRes.colleges;
                groupColleges();
                populateCollegeSelect();
                onTypeChange();
            }
        } catch (error) {
            console.error("초기 데이터 로딩 실패:", error);
            Swal.fire('오류', '초기 데이터를 불러오는 데 실패했습니다.', 'error');
        }
    }

    function groupColleges() {
        colleges.forEach(c => {
            if (!collegeGroups[c.대학명]) collegeGroups[c.대학명] = {};
            if (!collegeGroups[c.대학명][c.학과명]) collegeGroups[c.대학명][c.학과명] = [];
            collegeGroups[c.대학명][c.학과명].push(c.전형명);
        });
    }

    function populateCollegeSelect() {
        document.getElementById('sel-college').innerHTML = '<option value="">선택</option>' + Object.keys(collegeGroups).sort().map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function onCollegeChange() {
        const c = document.getElementById('sel-college').value;
        const s = document.getElementById('sel-major');
        s.innerHTML = '<option value="">선택</option>';
        document.getElementById('sel-type').innerHTML = '<option value="">선택</option>';
        if (c && collegeGroups[c]) {
            s.innerHTML += Object.keys(collegeGroups[c]).sort().map(m => `<option value="${m}">${m}</option>`).join('');
            s.disabled = false;
        } else {
            s.disabled = true;
            document.getElementById('sel-type').disabled = true;
        }
    }

    function onMajorChange() {
        const c = document.getElementById('sel-college').value;
        const m = document.getElementById('sel-major').value;
        const t = document.getElementById('sel-type');
        t.innerHTML = '<option value="">선택</option>';
        if (m && collegeGroups[c]?.[m]) {
            t.innerHTML += collegeGroups[c][m].sort().map(type => `<option value="${type}">${type}</option>`).join('');
            t.disabled = false;
        } else {
            t.disabled = true;
        }
    }
    
    function onTypeChange() {
        searchRanking();
    }

    async function searchRanking() {
        const c = document.getElementById('sel-college').value;
        const m = document.getElementById('sel-major').value;
        const t = document.getElementById('sel-type').value;
        const resultTitle = document.getElementById('result-title');
        
        if (!c || !m || !t) {
            renderTable([], []);
            resultTitle.textContent = '대학/학과/전형을 선택해주세요.';
            return;
        }

        const currentCollege = colleges.find(col => col.대학명 === c && col.학과명 === m && col.전형명 === t);
        if (!currentCollege) return;
        
        Swal.fire({ title: '전체 지점 데이터 조회 중...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        resultTitle.textContent = `[${c} ${m} (${t})] 실시간 순위`;
        
        const res = await fetch(`${SERVER}/26susi/realtime-rank-by-college?college_id=${currentCollege.대학ID}`, { 
            headers: { 'Authorization': 'Bearer ' + token } 
        });
        const data = await res.json();
        Swal.close();
        
        if (data.success) {
            resultTitle.textContent += ` (총 ${data.ranking.length}명)`;
            renderTable(data.ranking, data.events);
        } else {
            Swal.fire('오류', '데이터 조회 중 문제가 발생했습니다.', 'error');
            renderTable([], []);
        }
    }

    function renderTable(rankingData, events = []) {
        const thead = document.getElementById('resultTable').querySelector('thead');
        const tbody = document.getElementById('resultTable').querySelector('tbody');
        
        let headerRow1HTML = `<tr><th rowspan="2">순위</th><th rowspan="2">지점</th><th rowspan="2">이름</th><th rowspan="2">성별</th>`;
        let headerRow2HTML = `<tr>`;
        events.forEach(event => {
            headerRow1HTML += `<th colspan="2">${event}</th>`;
            headerRow2HTML += `<th class="col-record">기록</th><th class="col-score">점수</th>`;
        });
        headerRow1HTML += `<th rowspan="2">내신점수</th><th rowspan="2">실기총점</th><th rowspan="2">합산점수</th></tr>`;
        headerRow2HTML += `</tr>`;
        thead.innerHTML = headerRow1HTML + headerRow2HTML;
        
        const totalColumns = 4 + (events.length * 2) + 3;

        if (rankingData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${totalColumns}">조회할 대학을 선택했거나, 해당 전형에 수합된 학생이 없습니다.</td></tr>`;
            return;
        }
        
        tbody.innerHTML = rankingData.map(student => {
            // ▼▼▼ 3. 학생 지점명과 로그인한 원장님 지점명을 비교해서 클래스 추가 ▼▼▼
            const isMyBranch = student.지점명 === loggedInUserBranch;
            const rowClass = isMyBranch ? 'my-branch-row' : '';
            const rankClass = student.순위 <= 3 ? 'rank-top3' : '';
            
            let rowHTML = `<tr class="${rowClass}">
                                <td class="${rankClass}">${student.순위}</td>
                                <td>${student.지점명}</td>
                                <td>${student.이름}</td>
                                <td>${student.성별}</td>`;
            
            for (let i = 1; i <= events.length; i++) {
                rowHTML += `<td class="col-record">${student['기록'+i] || '-'}</td>`;
                rowHTML += `<td class="col-score">${student['점수'+i] || '-'}</td>`;
            }
            
            rowHTML += `    <td>${student.내신점수 || '-'}</td>
                                <td>${student.실기총점 !== null ? parseFloat(student.실기총점).toFixed(2) : '-'}</td>
                                <td><strong>${student.합산점수 !== null ? parseFloat(student.합산점수).toFixed(2) : '-'}</strong></td>
                           </tr>`;
            return rowHTML;
        }).join('');
    }

    loadInitialData();
    </script>
</body>
</html>
